<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion Agile - Planning Projet</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN + config custom -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Montserrat', 'sans-serif'],
            },
            colors: {
              primary: '#7C3AED', // violet
              accent: '#38BDF8', // bleu
              gold: '#FFD700',
              dark: '#18181B',
            },
            boxShadow: {
              magic: '0 8px 32px 0 rgba(124,58,237,0.25)',
            },
          },
        },
      }
    </script>
    <!-- Heroicons -->
    <script src="https://unpkg.com/heroicons@2.0.13/dist/heroicons.min.js"></script>
    <!-- React & ReactDOM CDN -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel pour JSX inline -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f3e8ff 0%, #f9fafb 100%);
        min-height: 100vh;
      }
      .fade-in {
        animation: fadeIn 1s cubic-bezier(.39,.575,.565,1) both;
      }
      @keyframes fadeIn {
        0% { opacity: 0; transform: translateY(30px); }
        100% { opacity: 1; transform: none; }
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-primary/10 via-accent/10 to-white min-h-screen relative">
    <!-- Header -->
    <header class="w-full py-6 px-4 bg-white/80 backdrop-blur shadow-md fixed top-0 left-0 z-20 fade-in">
      <div class="max-w-5xl mx-auto flex items-center gap-4">
        <span class="inline-block bg-primary rounded-full p-2 shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2" />
            <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="#7C3AED" />
          </svg>
        </span>
        <div>
          <h1 class="text-3xl font-extrabold font-display text-primary tracking-tight">Gestion Agile</h1>
          <div class="text-sm text-gray-500 font-semibold">Le planning qui fait rêver les chefs de projet ✨</div>
        </div>
        <a href="dashboard.html" class="ml-auto px-5 py-2 rounded-lg font-bold text-white bg-accent hover:bg-primary transition shadow">Dashboard</a>
      </div>
    </header>
    <!-- Main -->
    <main class="max-w-5xl mx-auto pt-32 pb-16 px-4 fade-in">
      <div id="root"></div>
    </main>
    <!-- Footer -->
    <footer class="w-full py-6 px-4 bg-white/80 backdrop-blur shadow-inner fixed bottom-0 left-0 z-10 fade-in">
      <div class="max-w-5xl mx-auto flex items-center justify-between text-sm text-gray-500">
        <span>© <span id="year"></span> <span class="font-bold text-primary">Velocity of a City</span></span>
        <span>Fait avec <span class="text-accent">♥</span> et beaucoup de <span class="text-gold">chocolat</span> !</span>
      </div>
    </footer>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const yearSpan = document.getElementById('year');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();
      });
    </script>
    <script type="text/babel">
      // Composant principal
      function App() {
        // === 1. Constantes ===
        const SPRINT_DAYS = 10; // Durée d'un sprint en jours ouvrés
        const POINTS_PAR_STATUT = {
          'Débutant': 30,
          'Junior': 45,
          'Confirmé': 60,
          'Senior': 75,
        };

        // === 2. Structures de données ===
        // LocalStorage helpers
        function loadLS(key, def) {
          try {
            return JSON.parse(localStorage.getItem(key)) || def;
          } catch {
            return def;
          }
        }
        function saveLS(key, val) {
          localStorage.setItem(key, JSON.stringify(val));
        }

        // Chargement initial depuis localStorage
        const [devs, setDevs] = React.useState(() => loadLS('devs', []));
        const [projects, setProjects] = React.useState(() => loadLS('projects', []).map(p => ({...p, fini: p.fini ?? false})));
        const [sprints, setSprints] = React.useState(() => loadLS('sprints', []));

        // Sauvegarde à chaque modification
        React.useEffect(() => { saveLS('devs', devs); }, [devs]);
        React.useEffect(() => { saveLS('projects', projects); }, [projects]);
        React.useEffect(() => { saveLS('sprints', sprints); }, [sprints]);

        // absences: { [sprintIndex]: nbJours }

        // === 3. Fonctions utilitaires ===

        // Calcule les points disponibles pour un dev sur un sprint donné
        function getPointsDispo(dev, sprintIndex) {
          const base = POINTS_PAR_STATUT[dev.statut] || 0;
          const absenceData = dev.absences?.[sprintIndex];
          const abs = typeof absenceData === 'number' ? absenceData : (absenceData?.jours || 0);
          const ratio = Math.max(0, 1 - abs / SPRINT_DAYS);
          return Math.round(base * ratio);
        }

        // Calcule la capacité totale de l'équipe pour un sprint donné
        function getCapaciteSprint(devs, sprintIndex) {
          return devs.reduce((sum, dev) => sum + getPointsDispo(dev, sprintIndex), 0);
        }

        // Répartition automatique des projets sur les sprints et les devs
        function genererPlanning(devs, projects) {
          // Tri des projets par priorité croissante
          const projetsTries = [...projects].sort((a, b) => a.priorite - b.priorite);
          let sprintIndex = 0;
          let projetsRestants = projetsTries.map(p => ({ ...p, pointsRestants: p.points, debut: null, fin: null, sprints: 0, devsAffectes: [] }));

          // On boucle tant qu'il reste des projets à finir
          while (projetsRestants.some(p => p.pointsRestants > 0)) {
            // Réinitialiser les points disponibles pour ce sprint
            let devsState = devs.map(dev => ({
              ...dev,
              pointsDispo: getPointsDispo(dev, sprintIndex)
            }));

            // Première passe : identifier tous les projets actifs ce sprint
            let projetsActifs = projetsRestants.filter(p => p.pointsRestants > 0);
            
            // Deuxième passe : répartition intelligente basée sur les priorités
            for (let projet of projetsActifs) {
              if (projet.pointsRestants <= 0) continue;
              if (projet.debut === null) projet.debut = sprintIndex;
              let pointsAffectes = 0;
              
              // Déterminer les devs à utiliser pour ce projet
              let devsPourProjet = Array.isArray(projet.devsAffectesIds) && projet.devsAffectesIds.length > 0
                ? devsState.filter(d => projet.devsAffectesIds.includes(d.id))
                : devsState;
              
              // Répartition intelligente sur les devs affectés
              for (let dev of devsPourProjet) {
                if (dev.pointsDispo <= 0 || projet.pointsRestants <= 0) continue;
                
                // Identifier tous les projets actifs sur ce dev
                let projetsSurCeDev = projetsActifs.filter(p => {
                  if (p.pointsRestants <= 0) return false;
                  let devsDuProjet = Array.isArray(p.devsAffectesIds) && p.devsAffectesIds.length > 0
                    ? devsState.filter(d => p.devsAffectesIds.includes(d.id))
                    : devsState;
                  return devsDuProjet.some(d => d.id === dev.id);
                });
                
                // Grouper les projets par priorité
                let projetsParPriorite = {};
                projetsSurCeDev.forEach(p => {
                  if (!projetsParPriorite[p.priorite]) {
                    projetsParPriorite[p.priorite] = [];
                  }
                  projetsParPriorite[p.priorite].push(p);
                });
                
                let pointsPourCeDev = 0;
                const priorites = Object.keys(projetsParPriorite).map(Number).sort((a, b) => a - b);
                
                // Logique de répartition basée sur les priorités
                if (priorites.length === 1) {
                  // Même priorité : répartition équitable
                  const nbProjets = projetsParPriorite[priorites[0]].length;
                  pointsPourCeDev = Math.floor(dev.pointsDispo / nbProjets);
                } else if (priorites.length === 2) {
                  const prioriteHaute = priorites[0];
                  const prioriteBasse = priorites[1];
                  
                  if (prioriteHaute === 1 && prioriteBasse === 3) {
                    // Priorité 1 vs 3 : séquentiel (priorité 1 d'abord)
                    if (projet.priorite === 1) {
                      pointsPourCeDev = dev.pointsDispo; // 100% pour priorité 1
                    } else {
                      pointsPourCeDev = 0; // 0% pour priorité 3 (attendre)
                    }
                  } else {
                    // Autres cas : 80/20
                    if (projet.priorite === prioriteHaute) {
                      pointsPourCeDev = Math.floor(dev.pointsDispo * 0.8);
                    } else {
                      pointsPourCeDev = Math.floor(dev.pointsDispo * 0.2);
                    }
                  }
                } else {
                  // Plus de 2 priorités : priorité la plus haute d'abord
                  const prioriteMin = Math.min(...priorites);
                  if (projet.priorite === prioriteMin) {
                    pointsPourCeDev = dev.pointsDispo; // 100% pour priorité la plus haute
                  } else {
                    pointsPourCeDev = 0; // 0% pour les autres (attendre)
                  }
                }
                
                // Appliquer les limites
                pointsPourCeDev = Math.min(pointsPourCeDev, projet.pointsRestants, dev.pointsDispo);
                
                dev.pointsDispo -= pointsPourCeDev;
                projet.pointsRestants -= pointsPourCeDev;
                pointsAffectes += pointsPourCeDev;
                if (!projet.devsAffectes.includes(dev.nom)) projet.devsAffectes.push(dev.nom);
              }
              
              if (pointsAffectes > 0) projet.sprints++;
              if (projet.pointsRestants <= 0 && projet.fin === null) projet.fin = sprintIndex;
            }
            sprintIndex++;
          }
          
          // Ajout d'une marge de 1 sprint par projet
          for (let projet of projetsRestants) {
            projet.sprints += 1;
            projet.fin = (projet.fin ?? 0) + 1;
          }
          return projetsRestants;
        }

        // === 4. Exemple d'utilisation (sera remplacé par l'UI) ===
        // const planning = genererPlanning(devs, projects);

        return (
          <div className="space-y-12">
            <section className="fade-in">
              <SprintList sprints={sprints} setSprints={setSprints} />
            </section>
            <section className="fade-in">
              <DevInput devs={devs} setDevs={setDevs} POINTS_PAR_STATUT={POINTS_PAR_STATUT} />
            </section>
            <section className="fade-in">
              <ProjectInput projects={projects} setProjects={setProjects} devs={devs} />
            </section>
            <section className="fade-in">
              <SprintConfig devs={devs} setDevs={setDevs} sprints={sprints} />
            </section>
            <section className="fade-in">
              <PlanningView devs={devs} projects={projects} genererPlanning={genererPlanning} setProjects={setProjects} />
            </section>
          </div>
        );
      }

      // Saisie des développeurs
      function DevInput({ devs, setDevs, POINTS_PAR_STATUT }) {
        const [nom, setNom] = React.useState("");
        const [prenom, setPrenom] = React.useState("");
        const [statut, setStatut] = React.useState("Débutant");
        const [editMode, setEditMode] = React.useState(false);
        const [editId, setEditId] = React.useState(null);

        // Points auto selon le statut
        const points = POINTS_PAR_STATUT[statut] || 0;

        function handleSubmit(e) {
          e.preventDefault();
          if (!nom.trim() || !prenom.trim()) return;
          if (editMode && editId !== null) {
            setDevs(devs => devs.map(dev =>
              dev.id === editId
                ? { ...dev, nom: nom.trim(), prenom: prenom.trim(), statut }
                : dev
            ));
            setEditMode(false);
            setEditId(null);
          } else {
            setDevs(devs => [
              ...devs,
              {
                id: Date.now(),
                nom: nom.trim(),
                prenom: prenom.trim(),
                statut,
                absences: {},
              },
            ]);
          }
          setNom("");
          setPrenom("");
          setStatut("Débutant");
        }

        function handleEdit(dev) {
          setNom(dev.nom);
          setPrenom(dev.prenom);
          setStatut(dev.statut);
          setEditMode(true);
          setEditId(dev.id);
        }

        function handleCancelEdit() {
          setEditMode(false);
          setEditId(null);
          setNom("");
          setPrenom("");
          setStatut("Débutant");
        }

        function handleDelete(devId) {
          if (window.confirm('Supprimer ce développeur ?')) {
            setDevs(devs => devs.filter(dev => dev.id !== devId));
            if (editId === devId) {
              setEditMode(false);
              setEditId(null);
              setNom("");
              setPrenom("");
              setStatut("Débutant");
            }
          }
        }

        return (
            <section className="bg-white/90 p-8 rounded-2xl shadow-magic border border-primary/10 mb-8 transition-all duration-300 hover:shadow-2xl">
              <h2 className="text-2xl font-bold font-display text-primary mb-4 flex items-center gap-2">
                <svg className="w-7 h-7 text-accent" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M5.121 17.804A13.937 13.937 0 0112 15c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Développeurs
              </h2>
              <form className="flex flex-col md:flex-row md:items-end gap-4 mb-6" onSubmit={handleSubmit}>
                <div className="flex-1">
                  <label className="block text-sm font-semibold mb-1 text-gray-700">Prénom</label>
                  <input type="text" className="w-full border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition" value={prenom} onChange={e => setPrenom(e.target.value)} required />
                </div>
                <div className="flex-1">
                  <label className="block text-sm font-semibold mb-1 text-gray-700">Nom</label>
                  <input type="text" className="w-full border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition" value={nom} onChange={e => setNom(e.target.value)} required />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-1 text-gray-700">Statut</label>
                  <select className="w-full border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition" value={statut} onChange={e => setStatut(e.target.value)}>
                    {Object.keys(POINTS_PAR_STATUT).map(s => (
                      <option key={s} value={s}>{s}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-1 text-gray-700">Points/sprint</label>
                  <input type="text" className="w-20 border-2 border-primary/10 rounded-lg px-3 py-2 bg-gray-100 text-center font-bold" value={points} readOnly />
                </div>
                <button type="submit" className={"px-5 py-2 rounded-lg font-bold text-white shadow transition-all duration-200 " + (editMode ? "bg-primary hover:bg-primary/90" : "bg-accent hover:bg-accent/80")}>{editMode ? "Modifier" : "Ajouter"}</button>
                {editMode && (
                  <button type="button" className="ml-2 px-4 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-700 transition" onClick={handleCancelEdit}>Annuler</button>
                )}
              </form>
              <div>
                <h3 className="font-semibold mb-2 text-gray-700">Liste des développeurs</h3>
                {devs.length === 0 ? (
                  <div className="text-gray-400 italic">Aucun développeur saisi.</div>
                ) : (
                  <ul className="divide-y">
                    {devs.map(dev => (
                      <li key={dev.id} className="py-2 flex items-center gap-4 group">
                        <span className="font-medium text-dark">{dev.prenom} {dev.nom}</span>
                        <span className="text-sm text-primary font-semibold">{dev.statut}</span>
                        <span className="text-xs text-gray-400">{POINTS_PAR_STATUT[dev.statut]} pts/sprint</span>
                        <button type="button" className="ml-2 text-accent hover:text-primary font-bold opacity-70 group-hover:opacity-100 transition" title="Modifier" onClick={() => handleEdit(dev)}>
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M15.232 5.232l3.536 3.536M9 13l6-6M3 21h18" /></svg>
                        </button>
                        <button type="button" className="ml-2 text-red-400 hover:text-red-600 font-bold opacity-70 group-hover:opacity-100 transition" title="Supprimer" onClick={() => handleDelete(dev.id)}>
                          <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                      </li>
                    ))}
                  </ul>
                )}
              </div>
            </section>
        );
      }

      // Saisie des projets
      function ProjectInput({ projects, setProjects, devs }) {
        const [nom, setNom] = React.useState("");
        const [priorite, setPriorite] = React.useState(1);
        const [points, setPoints] = React.useState(0);
        const [dateDebut, setDateDebut] = React.useState("");
        const [devsAffectesIds, setDevsAffectesIds] = React.useState([]);
        const [editMode, setEditMode] = React.useState(false);
        const [editId, setEditId] = React.useState(null);

        // Synchronise la sélection des devs affectés lors du passage en édition
        React.useEffect(() => {
          if (editMode && editId !== null) {
            const proj = projects.find(p => p.id === editId);
            setDevsAffectesIds(proj && proj.devsAffectesIds ? proj.devsAffectesIds : []);
            setDateDebut(proj && proj.dateDebut ? proj.dateDebut : "");
          }
        }, [editMode, editId, projects]);

        // Sélecteur custom multi-tags pour les devs
        const [showDropdown, setShowDropdown] = React.useState(false);
        const inputRef = React.useRef();
        const dropdownRef = React.useRef();

        function handleAddDev(devId) {
          if (!devsAffectesIds.includes(devId)) {
            setDevsAffectesIds(ids => [...ids, devId]);
          }
          setShowDropdown(false);
        }
        function handleRemoveDev(devId) {
          setDevsAffectesIds(ids => ids.filter(id => id !== devId));
        }
        function handleInputClick() {
          setShowDropdown(true);
          if (inputRef.current) inputRef.current.focus();
        }
        function handleBlur(e) {
          // Ferme le dropdown si on clique en dehors
          setTimeout(() => {
            if (!dropdownRef.current || !dropdownRef.current.contains(document.activeElement)) {
              setShowDropdown(false);
            }
          }, 150);
        }

        function handleSubmit(e) {
          e.preventDefault();
          if (!nom.trim() || !priorite || !points) return;
          if (editMode && editId !== null) {
            setProjects(projects => projects.map(proj =>
              proj.id === editId
                ? {
                    ...proj,
                    nom: nom.trim(),
                    priorite: Number(priorite),
                    points: Number(points),
                    devsAffectesIds: devsAffectesIds.length > 0 ? devsAffectesIds : undefined,
                    dateDebut: dateDebut || undefined,
                    fini: proj.fini ?? false,
                  }
                : proj
            ));
            setEditMode(false);
            setEditId(null);
          } else {
            setProjects(projects => [
              ...projects,
              {
                id: Date.now(),
                nom: nom.trim(),
                priorite: Number(priorite),
                points: Number(points),
                devsAffectesIds: devsAffectesIds.length > 0 ? devsAffectesIds : undefined,
                dateDebut: dateDebut || undefined,
                fini: false,
              },
            ]);
          }
          setNom("");
          setPriorite(1);
          setPoints(0);
          setDevsAffectesIds([]);
          setDateDebut("");
        }

        function handleEdit(proj) {
          setNom(proj.nom);
          setPriorite(proj.priorite);
          setPoints(proj.points);
          setEditMode(true);
          setEditId(proj.id);
        }

        function handleCancelEdit() {
          setEditMode(false);
          setEditId(null);
          setNom("");
          setPriorite(1);
          setPoints(0);
          setDevsAffectesIds([]);
          setDateDebut("");
        }

        function handleDelete(projId) {
          if (window.confirm('Supprimer ce projet ?')) {
            setProjects(projects => projects.filter(proj => proj.id !== projId));
            if (editId === projId) {
              setEditMode(false);
              setEditId(null);
              setNom("");
              setPriorite(1);
              setPoints(0);
              setDevsAffectesIds([]);
              setDateDebut("");
            }
          }
        }

        // Tri par priorité croissante
        const projetsTries = [...projects].sort((a, b) => a.priorite - b.priorite);

        return (
          <section className="bg-white/90 p-8 rounded-2xl shadow-magic border border-primary/10 mb-8 transition-all duration-300 hover:shadow-2xl">
            <h2 className="text-2xl font-bold font-display text-primary mb-4 flex items-center gap-2">
              <svg className="w-7 h-7 text-accent" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
              Projets
            </h2>
            <form className="flex flex-col gap-2 mb-6" onSubmit={handleSubmit}>
              <div className="flex flex-col md:flex-row md:items-end gap-4">
                <div className="flex-1">
                  <label className="block text-sm font-semibold mb-1 text-gray-700">Nom du projet</label>
                  <input type="text" className="w-full border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition h-10" value={nom} onChange={e => setNom(e.target.value)} required />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-1 text-gray-700">Date de début</label>
                  <input type="date" className="w-44 border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition h-10" value={dateDebut} onChange={e => setDateDebut(e.target.value)} />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-1 text-gray-700">Priorité</label>
                  <input type="number" min="1" className="w-20 border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition h-10" value={priorite} onChange={e => setPriorite(e.target.value)} required />
                </div>
                <div>
                  <label className="block text-sm font-semibold mb-1 text-gray-700">Points estimés</label>
                  <input type="number" min="1" className="w-24 border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition h-10" value={points} onChange={e => setPoints(e.target.value)} required />
                </div>
                <button type="submit" className={"px-5 py-2 rounded-lg font-bold text-white shadow transition-all duration-200 " + (editMode ? "bg-primary hover:bg-primary/90" : "bg-green-600 hover:bg-green-700")}>{editMode ? "Modifier" : "Ajouter"}</button>
                {editMode && (
                  <button type="button" className="ml-2 px-4 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-700 transition mt-6 md:mt-0" onClick={handleCancelEdit}>Annuler</button>
                )}
              </div>
              <div className="flex flex-col gap-1 mt-2">
                <label className="block text-sm font-semibold mb-1 text-gray-700">Développeurs affectés</label>
                <div className="flex gap-2 items-center relative">
                  <div
                    className="flex flex-wrap gap-1 border rounded px-2 py-0 bg-gray-50 h-10 min-h-[40px] cursor-pointer w-full items-center"
                    tabIndex={0}
                    ref={inputRef}
                    onClick={handleInputClick}
                    onBlur={handleBlur}
                    style={{overflowY: 'auto'}}
                  >
                    {devsAffectesIds.length === 0 && (
                      <span className="text-gray-400">Tous les devs</span>
                    )}
                    {devsAffectesIds.map(id => {
                      const dev = devs.find(d => d.id === id);
                      if (!dev) return null;
                      return (
                        <span key={id} className="bg-accent/20 text-accent rounded px-2 py-0.5 flex items-center gap-1">
                          {dev.prenom} {dev.nom}
                          <button type="button" className="ml-1 text-accent hover:text-primary font-bold" title="Retirer" onClick={e => { e.stopPropagation(); handleRemoveDev(id); }}>
                            ×
                          </button>
                        </span>
                      );
                    })}
                  </div>
                  <button
                    type="button"
                    className="bg-accent/10 text-accent px-2 py-1 rounded border border-accent/20 hover:bg-accent/20 text-sm font-semibold h-10"
                    style={{ minWidth: '40px' }}
                    onClick={handleInputClick}
                  >
                    Ajouter un développeur
                  </button>
                 {showDropdown && (
                   <div ref={dropdownRef} tabIndex={-1} className="absolute top-12 left-0 z-10 bg-white border border-primary/10 rounded-lg shadow-lg p-2 w-full max-h-48 overflow-y-auto animate-fade-in">
                     {devs.filter(d => !devsAffectesIds.includes(d.id)).length === 0 ? (
                       <div className="text-gray-400 px-2 py-1">Tous les développeurs sont déjà sélectionnés.</div>
                     ) : (
                       devs.filter(d => !devsAffectesIds.includes(d.id)).map(dev => (
                         <button
                           key={dev.id}
                           type="button"
                           className="block w-full text-left px-3 py-2 rounded hover:bg-accent/10 text-dark font-medium transition"
                           onClick={() => handleAddDev(dev.id)}
                         >
                           {dev.prenom} {dev.nom}
                         </button>
                       ))
                     )}
                   </div>
                 )}
                </div>
                <div className="text-xs text-gray-400 mt-1">(Aucun sélectionné = tous les devs)</div>
              </div>
            </form>
            <div>
              <h3 className="font-semibold mb-2 text-gray-700">Liste des projets</h3>
              {projetsTries.length === 0 ? (
                <div className="text-gray-400 italic">Aucun projet saisi.</div>
              ) : (
                <ul className="divide-y">
                  {projetsTries.map(proj => (
                    <li key={proj.id} className="py-2 flex flex-col md:flex-row md:items-center gap-2 md:gap-4">
                      <span className="font-medium text-dark">{proj.nom}</span>
                      <span className="text-sm text-primary font-semibold">Priorité {proj.priorite}</span>
                      <span className="text-xs text-gray-400">{proj.points} pts</span>
                      <span className="text-xs text-gray-500">{(proj.devsAffectesIds && proj.devsAffectesIds.length > 0)
                        ? devs.filter(d => proj.devsAffectesIds.includes(d.id)).map(d => d.prenom + ' ' + d.nom).join(', ')
                        : 'Tous les devs'}</span>
                      {proj.dateDebut && <span className="text-xs text-gray-400">Débute le {proj.dateDebut}</span>}
                      <button type="button" className="ml-2 text-accent hover:text-primary font-bold opacity-70 group-hover:opacity-100 transition" title="Modifier" onClick={() => handleEdit(proj)}>
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                      </button>
                      <button type="button" className="ml-2 text-red-400 hover:text-red-600 font-bold opacity-70 group-hover:opacity-100 transition" title="Supprimer" onClick={() => handleDelete(proj.id)}>
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                      </button>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </section>
        );
      }

      // Saisie des indisponibilités par sprint
      function SprintConfig({ devs, setDevs, sprints = [] }) {
        const [dateDebut, setDateDebut] = React.useState("");
        const [dateFin, setDateFin] = React.useState("");
        const [devId, setDevId] = React.useState("");
        const [typeAbsence, setTypeAbsence] = React.useState("Congés");
        const [editMode, setEditMode] = React.useState(false);
        const [editTarget, setEditTarget] = React.useState(null); // {devId, dateDebut}

        // Types d'absence avec leurs couleurs
        const TYPES_ABSENCE = {
          'Congés': { color: 'bg-blue-100 text-blue-800 border-blue-200', icon: '🏖️' },
          'Maladie': { color: 'bg-red-100 text-red-800 border-red-200', icon: '🏥' },
          'Formation': { color: 'bg-purple-100 text-purple-800 border-purple-200', icon: '📚' },
          'Télétravail': { color: 'bg-green-100 text-green-800 border-green-200', icon: '🏠' },
          'Déplacement': { color: 'bg-orange-100 text-orange-800 border-orange-200', icon: '✈️' },
          'Autre': { color: 'bg-gray-100 text-gray-800 border-gray-200', icon: '📋' }
        };

        // Points par statut (pour le calcul)
        const POINTS_PAR_STATUT = {
          'Débutant': 30,
          'Junior': 45,
          'Confirmé': 60,
          'Senior': 75,
        };
        const SPRINT_DAYS = 10;

        // Ajout ou modification d'une absence
        function handleSubmit(e) {
          e.preventDefault();
          if (!devId || !dateDebut || !dateFin || !typeAbsence) return;
          // Calculer le nombre de jours d'absence (date de fin incluse)
          const debut = new Date(dateDebut);
          const fin = new Date(dateFin);
          const diffTime = fin.getTime() - debut.getTime();
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 car date de fin incluse
          
          setDevs(devs => devs.map(dev => {
            if (dev.id !== Number(devId)) return dev;
            return {
              ...dev,
              absences: {
                ...dev.absences,
                [dateDebut]: { jours: diffDays, type: typeAbsence }
              }
            };
          }));
          setDateDebut("");
          setDateFin("");
          setTypeAbsence("Congés");
          setEditMode(false);
          setEditTarget(null);
          setDevId("");
        }

        // Suppression d'une absence
        function handleDeleteAbs(devIdToDel, dateDebutToDel) {
          setDevs(devs => devs.map(dev => {
            if (dev.id !== devIdToDel) return dev;
            const newAbs = { ...dev.absences };
            delete newAbs[dateDebutToDel];
            return { ...dev, absences: newAbs };
          }));
          // Si on était en édition de cette absence, reset
          if (editTarget && editTarget.devId === devIdToDel && editTarget.dateDebut === dateDebutToDel) {
            setEditMode(false);
            setEditTarget(null);
            setDateDebut("");
            setDateFin("");
            setDevId("");
          }
        }

        // Pré-remplir le formulaire pour édition
        function handleEditAbs(devIdEdit, dateDebutEdit, absenceData) {
          setDevId(devIdEdit.toString());
          setDateDebut(dateDebutEdit);
          
          // Gérer l'ancien format (nombre) et le nouveau format (objet)
          const nbJours = typeof absenceData === 'number' ? absenceData : absenceData.jours;
          const type = typeof absenceData === 'number' ? 'Congés' : absenceData.type;
          
          setTypeAbsence(type);
          
          // Calculer la date de fin à partir du nombre de jours
          const debut = new Date(dateDebutEdit);
          const fin = new Date(debut);
          fin.setDate(fin.getDate() + nbJours - 1); // -1 car date de fin incluse
          setDateFin(fin.toISOString().split('T')[0]);
          
          setEditMode(true);
          setEditTarget({ devId: devIdEdit, dateDebut: dateDebutEdit });
        }

        // Calcule les points restants pour un dev sur une date donnée
        function getPointsRestants(dev, dateDebut) {
          const base = POINTS_PAR_STATUT[dev.statut] || 0;
          const absenceData = dev.absences?.[dateDebut];
          const abs = typeof absenceData === 'number' ? absenceData : (absenceData?.jours || 0);
          const ratio = Math.max(0, 1 - abs / SPRINT_DAYS);
          return Math.round(base * ratio);
        }

        // Formatage date FR
        function formatDateFR(dateStr) {
          if (!dateStr) return "-";
          try {
            return new Date(dateStr).toLocaleDateString('fr-FR');
          } catch {
            return dateStr;
          }
        }

        return (
          <section className="bg-white/90 p-8 rounded-2xl shadow-magic border border-primary/10 mb-8 transition-all duration-300 hover:shadow-2xl">
            <h2 className="text-2xl font-bold font-display text-primary mb-4 flex items-center gap-2">
              <svg className="w-7 h-7 text-accent" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
              Indisponibilités par date
            </h2>
            {devs.length === 0 ? (
              <div className="text-gray-400 italic">Ajoutez d'abord des développeurs.</div>
            ) : (
              <>
                <form className="flex flex-col md:flex-row md:items-end gap-4 mb-6" onSubmit={handleSubmit}>
                  <div>
                    <label className="block text-sm font-semibold mb-1 text-gray-700">Développeur</label>
                    <select className="w-full border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition h-10" value={devId} onChange={e => setDevId(e.target.value)} required>
                      <option value="">Choisir…</option>
                      {devs.map(dev => (
                        <option key={dev.id} value={dev.id}>{dev.prenom} {dev.nom}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-semibold mb-1 text-gray-700">Type d'absence</label>
                    <select className="w-44 border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition h-10" value={typeAbsence} onChange={e => setTypeAbsence(e.target.value)} required>
                      {Object.keys(TYPES_ABSENCE).map(type => (
                        <option key={type} value={type}>{TYPES_ABSENCE[type].icon} {type}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-semibold mb-1 text-gray-700">Date de début</label>
                    <input type="date" className="w-44 border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition h-10" value={dateDebut} onChange={e => setDateDebut(e.target.value)} required />
                  </div>
                  <div>
                    <label className="block text-sm font-semibold mb-1 text-gray-700">Date de fin</label>
                    <input type="date" className="w-44 border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition h-10" value={dateFin} onChange={e => setDateFin(e.target.value)} required />
                  </div>
                  <button type="submit" className={"px-5 py-2 rounded-lg font-bold text-white shadow transition-all duration-200 " + (editMode ? "bg-primary hover:bg-primary/90" : "bg-yellow-600 hover:bg-yellow-700")}>{editMode ? "Modifier" : "Enregistrer"}</button>
                  {editMode && (
                    <button type="button" className="ml-2 px-4 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-700 transition" onClick={() => { setEditMode(false); setEditTarget(null); setDateDebut(""); setDateFin(""); setDevId(""); setTypeAbsence("Congés"); }}>Annuler</button>
                  )}
                </form>
                <div>
                  <h3 className="font-semibold mb-2 text-gray-700">Synthèse des absences</h3>
                  {devs.every(dev => !dev.absences || Object.keys(dev.absences).length === 0) ? (
                    <div className="text-gray-400 italic">Aucune absence saisie.</div>
                  ) : (
                    <ul className="divide-y">
                      {devs.map(dev => (
                        Object.keys(dev.absences || {}).length === 0 ? null : (
                          <li key={dev.id} className="py-2">
                            <span className="font-medium text-dark">{dev.prenom} {dev.nom} :</span>
                            {Object.entries(
                              Object.fromEntries(
                                Object.entries(dev.absences || {}).sort((a, b) => new Date(a[0]) - new Date(b[0]))
                              )
                            ).map(([date, absenceData]) => {
                              // Gérer l'ancien format (nombre) et le nouveau format (objet)
                              const nbJours = typeof absenceData === 'number' ? absenceData : absenceData.jours;
                              const type = typeof absenceData === 'number' ? 'Congés' : absenceData.type;
                              
                              // Trouver les n° de sprint(s) correspondant à la période d'absence
                              let sprintsNums = [];
                              if (sprints && sprints.length > 0 && date) {
                                const dateDebutAbs = new Date(date);
                                const dateFinAbs = new Date(date);
                                dateFinAbs.setDate(dateFinAbs.getDate() + Number(nbJours) - 1);
                                sprints.forEach(s => {
                                  const sprintDeb = new Date(s.dateDebut);
                                  const sprintFin = new Date(s.dateFin);
                                  if (
                                    (dateDebutAbs <= sprintFin && dateDebutAbs >= sprintDeb) || // commence dans le sprint
                                    (dateFinAbs >= sprintDeb && dateFinAbs <= sprintFin) || // finit dans le sprint
                                    (dateDebutAbs <= sprintDeb && dateFinAbs >= sprintFin) // englobe le sprint
                                  ) {
                                    sprintsNums.push(s.numero);
                                  }
                                });
                              }
                              // Calculer la date de fin à partir du nombre de jours
                              const dateDebutAbs = new Date(date);
                              const dateFinAbs = new Date(dateDebutAbs);
                              dateFinAbs.setDate(dateFinAbs.getDate() + Number(nbJours) - 1); // -1 car date de fin incluse
                              
                              return (
                                <span key={date} className="ml-2 text-sm text-primary font-semibold inline-flex items-center gap-1">
                                  <span className="inline-flex items-center gap-2">
                                    <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold border ${TYPES_ABSENCE[type]?.color || TYPES_ABSENCE['Autre'].color}`}>
                                      {TYPES_ABSENCE[type]?.icon || TYPES_ABSENCE['Autre'].icon} {type}
                                    </span>
                                    <span>
                                      Sprint {sprintsNums.length > 0 ? sprintsNums.join(', ') : '-'} : {formatDateFR(date)} → {formatDateFR(dateFinAbs.toISOString().split('T')[0])} ({nbJours}j, {getPointsRestants(dev, date)} pts)
                                    </span>
                                  </span>
                                  <button type="button" className="ml-1 text-accent hover:text-primary font-bold opacity-70 group-hover:opacity-100 transition" title="Modifier" onClick={() => handleEditAbs(dev.id, date, absenceData)}>
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                                  </button>
                                  <button type="button" className="ml-1 text-red-400 hover:text-red-600 font-bold opacity-70 group-hover:opacity-100 transition" title="Supprimer" onClick={() => handleDeleteAbs(dev.id, date)}>
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                  </button>
                                </span>
                              );
                            })}
                          </li>
                        )
                      ))}
                    </ul>
                  )}
                </div>
              </>
            )}
          </section>
        );
      }

      // 1. Composant Modal
      function Modal({ open, onClose, onConfirm, message, requireDate, onDateChange, dateValue }) {
        if (!open) return null;
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-xs w-full text-center animate-fade-in">
              <div className="mb-6 text-lg font-semibold text-dark">{message}</div>
              {requireDate && (
                <div className="mb-4">
                  <label className="block text-sm font-semibold mb-1 text-gray-700">Date de livraison</label>
                  <input type="date" className="w-full border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition" value={dateValue} onChange={e => onDateChange(e.target.value)} required />
                </div>
              )}
              <div className="flex justify-center gap-4">
                <button
                  className="px-5 py-2 rounded-lg font-bold text-white bg-green-500 hover:bg-green-600 transition"
                  onClick={onConfirm}
                  disabled={requireDate && !dateValue}
                  style={requireDate && !dateValue ? { opacity: 0.5, cursor: 'not-allowed' } : {}}
                >
                  Oui
                </button>
                <button
                  className="px-5 py-2 rounded-lg font-bold text-gray-700 bg-gray-200 hover:bg-gray-300 transition"
                  onClick={onClose}
                >
                  Annuler
                </button>
              </div>
            </div>
          </div>
        );
      }

      // Affichage du planning prévisionnel
      function PlanningView({ devs, projects, genererPlanning, setProjects }) {
        const SPRINT_DAYS = 10;
        if (devs.length === 0 || projects.length === 0) {
          return (
            <section className="bg-white/90 p-8 rounded-2xl shadow-magic border border-primary/10 mb-8 transition-all duration-300 hover:shadow-2xl">
              <h2 className="text-2xl font-bold font-display text-primary mb-4 flex items-center gap-2">
                <svg className="w-7 h-7 text-accent" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6l4 2" /></svg>
                Planning prévisionnel
              </h2>
              <div className="text-gray-400 italic">Ajoutez au moins un développeur et un projet pour générer le planning.</div>
            </section>
          );
        }

        const planning = genererPlanning(devs, projects);

        // Associer l'état 'fini' du projet d'origine
        const projectsById = Object.fromEntries(projects.map(p => [p.id, p]));
        const planningWithFini = planning.map(p => ({ ...p, fini: projectsById[p.id]?.fini ?? false }));

        // Handler pour changer l'état fini
        const [modalOpen, setModalOpen] = React.useState(false);
        const [modalTarget, setModalTarget] = React.useState(null); // {id, fini}
        const [modalDate, setModalDate] = React.useState("");

        function handleToggleFini(projId) {
          const proj = projects.find(p => p.id === projId);
          if (!proj) return;
          setModalTarget({ id: projId, fini: proj.fini });
          setModalDate("");
          setModalOpen(true);
        }
        function handleModalConfirm() {
          if (modalTarget) {
            setProjects(projects => projects.map(p => {
              if (p.id === modalTarget.id) {
                // Si on marque comme fini, on enregistre la date de livraison ET le nombre de sprints nécessaires
                if (!modalTarget.fini && modalDate) {
                  // On récupère le planning courant pour ce projet
                  const planning = genererPlanning(devs, projects);
                  const planProj = planning.find(pl => pl.id === p.id);
                  return { ...p, fini: true, dateFin: modalDate, sprints: planProj ? planProj.sprints : p.sprints };
                }
                // Si on remet en non fini, on efface la date de livraison et le champ sprints
                if (modalTarget.fini) {
                  const { dateFin, sprints, ...rest } = p;
                  return { ...rest, fini: false };
                }
              }
              return p;
            }));
          }
          setModalOpen(false);
          setModalTarget(null);
          setModalDate("");
        }
        function handleModalClose() {
          setModalOpen(false);
          setModalTarget(null);
          setModalDate("");
        }

        // Calcule la date de fin prévisionnelle (statique - calculée à la création)
        function getDateFin(proj) {
          if (!proj.dateDebut) return "-";
          const d = new Date(proj.dateDebut);
          // On considère 1 sprint = SPRINT_DAYS jours ouvrés (on ajoute 2 jours par sprint pour simuler les week-ends)
          const totalDays = proj.sprints * (SPRINT_DAYS + 2);
          d.setDate(d.getDate() + totalDays);
          return d.toLocaleDateString('fr-FR');
        }

        // Calcule la date de fin prévisionnelle corrigée (dynamique - recalculée à chaque modification)
        function getDateFinCorrigee(proj) {
          if (!proj.dateDebut) return "-";
          
          // Générer le planning actuel avec toutes les modifications
          const planningActuel = genererPlanning(devs, projects);
          const projetActuel = planningActuel.find(p => p.id === proj.id);
          
          if (!projetActuel) return "-";
          
          const d = new Date(proj.dateDebut);
          // On considère 1 sprint = SPRINT_DAYS jours ouvrés (on ajoute 2 jours par sprint pour simuler les week-ends)
          const totalDays = projetActuel.sprints * (SPRINT_DAYS + 2);
          d.setDate(d.getDate() + totalDays);
          return d.toLocaleDateString('fr-FR');
        }

        function getFinStatusColor(proj) {
          if (proj.fini) return 'bg-green-50';
          // On parse la date de fin prévisionnelle
          const dateFinStr = getDateFin(proj);
          if (!dateFinStr || dateFinStr === '-') return '';
          const [jour, mois, annee] = dateFinStr.split('/').map(Number);
          const dateFin = new Date(annee, mois - 1, jour);
          const now = new Date();
          // On ignore l'heure pour la comparaison
          dateFin.setHours(0,0,0,0);
          now.setHours(0,0,0,0);
          const diffJours = Math.ceil((dateFin - now) / (1000 * 60 * 60 * 24));
          if (diffJours < 0) return 'bg-red-50';
          if (diffJours <= 7) return 'bg-orange-50';
          return '';
        }

        // Trie par priorité puis date de début
        const planningSorted = [...planningWithFini].sort((a, b) => {
          if (a.priorite !== b.priorite) return a.priorite - b.priorite;
          // Si pas de date, on met à la fin
          if (!a.dateDebut && b.dateDebut) return 1;
          if (a.dateDebut && !b.dateDebut) return -1;
          if (!a.dateDebut && !b.dateDebut) return 0;
          return new Date(a.dateDebut) - new Date(b.dateDebut);
        });

        // Filtres
        const [filtrePriorite, setFiltrePriorite] = React.useState('');
        const [filtreEtat, setFiltreEtat] = React.useState('');
        const [filtreDev, setFiltreDev] = React.useState('');

        // Helper pour état du projet
        function getEtatProjet(proj) {
          if (proj.fini) return 'livre';
          const dateFinStr = getDateFin(proj);
          if (!dateFinStr || dateFinStr === '-') return 'en_cours';
          const [jour, mois, annee] = dateFinStr.split('/').map(Number);
          const dateFin = new Date(annee, mois - 1, jour);
          const now = new Date();
          dateFin.setHours(0,0,0,0);
          now.setHours(0,0,0,0);
          const diffJours = Math.ceil((dateFin - now) / (1000 * 60 * 60 * 24));
          if (diffJours < 0) return 'retard';
          if (diffJours <= 7) return 'bientot_retard';
          return 'en_cours';
        }

        // Filtrage
        const planningFiltred = planningSorted.filter(proj => {
          if (filtrePriorite && String(proj.priorite) !== filtrePriorite) return false;
          if (filtreEtat) {
            const etat = getEtatProjet(proj);
            if (filtreEtat === 'en_cours' && etat !== 'en_cours') return false;
            if (filtreEtat === 'livre' && etat !== 'livre') return false;
            if (filtreEtat === 'retard' && etat !== 'retard') return false;
            if (filtreEtat === 'bientot_retard' && etat !== 'bientot_retard') return false;
          }
          if (filtreDev) {
            if (!proj.devsAffectesIds || !proj.devsAffectesIds.includes(Number(filtreDev))) return false;
          }
          return true;
        });

        return (
          <section className="bg-white/90 p-8 rounded-2xl shadow-magic border border-primary/10 mb-8 transition-all duration-300 hover:shadow-2xl">
            <h2 className="text-2xl font-bold font-display text-primary mb-4 flex items-center gap-2">
              <svg className="w-8 h-8 text-accent -mt-1" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24">
                <rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" strokeWidth="2"/>
                <path strokeLinecap="round" strokeLinejoin="round" d="M16 3v4M8 3v4M3 11h18" />
              </svg>
              Planning prévisionnel
            </h2>
            {/* Filtres */}
            <div className="flex flex-wrap gap-4 mb-6 items-end">
              <div>
                <label className="block text-xs font-semibold text-gray-600 mb-1">Priorité</label>
                <select className="border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition bg-white shadow-sm" value={filtrePriorite} onChange={e => setFiltrePriorite(e.target.value)}>
                  <option value="">Toutes</option>
                  {[...new Set(planningSorted.map(p => p.priorite))].sort((a,b)=>a-b).map(prio => (
                    <option key={prio} value={prio}>{prio}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-xs font-semibold text-gray-600 mb-1">État</label>
                <select className="border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition bg-white shadow-sm" value={filtreEtat} onChange={e => setFiltreEtat(e.target.value)}>
                  <option value="">Tous</option>
                  <option value="en_cours">En cours</option>
                  <option value="bientot_retard">Bientôt en retard</option>
                  <option value="retard">En retard</option>
                  <option value="livre">Livré</option>
                </select>
              </div>
              <div>
                <label className="block text-xs font-semibold text-gray-600 mb-1">Développeur</label>
                <select className="border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition bg-white shadow-sm" value={filtreDev} onChange={e => setFiltreDev(e.target.value)}>
                  <option value="">Tous</option>
                  {devs.map(dev => (
                    <option key={dev.id} value={dev.id}>{dev.prenom} {dev.nom}</option>
                  ))}
                </select>
              </div>
            </div>
            <div className="overflow-x-auto">
              <table className="min-w-full border-separate border-spacing-0 rounded-2xl shadow-lg bg-white">
                <thead>
                  <tr className="bg-gradient-to-r from-primary/80 to-accent/80 text-white">
                    <th className="px-4 py-3 text-left font-bold rounded-tl-2xl">Projet</th>
                    <th className="px-4 py-3 text-left font-bold">Priorité</th>
                    <th className="px-4 py-3 text-left font-bold">Points</th>
                    <th className="px-4 py-3 text-left font-bold">Sprints nécessaires</th>
                    <th className="px-4 py-3 text-left font-bold">Date de fin prévisionnelle</th>
                    <th className="px-4 py-3 text-left font-bold">Date corrigée</th>
                    <th className="px-4 py-3 text-left font-bold">Devs affectés</th>
                    <th className="px-4 py-3 text-left font-bold rounded-tr-2xl">Fini ?</th>
                  </tr>
                </thead>
                <tbody>
                  {planningFiltred.map((proj, idx) => (
                    <tr key={proj.id} className={
                      "transition hover:bg-accent/10 " +
                      (getFinStatusColor(proj) || (idx % 2 === 0 ? "bg-gray-50" : "bg-white"))
                    }>
                      <td className="px-4 py-3 font-semibold text-dark text-base rounded-l-xl border-b border-gray-200">{proj.nom}</td>
                      <td className="px-4 py-3 border-b border-gray-200">
                        <span className={"inline-block px-2 py-1 rounded-full text-xs font-bold " +
                          (proj.priorite === 1 ? "bg-primary/90 text-white" :
                          proj.priorite === 2 ? "bg-accent/90 text-white" :
                          "bg-gray-200 text-gray-700")
                        }>
                          {proj.priorite}
                        </span>
                      </td>
                      <td className="px-4 py-3 border-b border-gray-200 text-gray-700 font-medium">{proj.points}</td>
                      <td className="px-4 py-3 border-b border-gray-200 text-gray-700 font-medium">{proj.sprints}</td>
                      <td className="px-4 py-3 border-b border-gray-200 text-gray-700 whitespace-nowrap">{getDateFin(proj)}
  {/* Affichage du retard en jours ou mois si projet en retard */}
  {(() => {
    if (proj.fini) return null;
    const dateFinStr = getDateFin(proj);
    if (!dateFinStr || dateFinStr === '-') return null;
    const [jour, mois, annee] = dateFinStr.split('/').map(Number);
    const dateFin = new Date(annee, mois - 1, jour);
    const now = new Date();
    dateFin.setHours(0,0,0,0);
    now.setHours(0,0,0,0);
    const diffJours = Math.ceil((now - dateFin) / (1000 * 60 * 60 * 24));
    if (diffJours > 0) {
      if (diffJours < 30) {
        return (
          <div className="text-xs text-red-600 font-bold mt-1">{diffJours} jour{diffJours > 1 ? 's' : ''} de retard</div>
        );
      } else {
        const moisRetard = Math.ceil(diffJours / 30);
        return (
          <div className="text-xs text-red-600 font-bold mt-1">{moisRetard} mois de retard</div>
        );
      }
    }
    return null;
  })()}
</td>
                      <td className="px-4 py-3 border-b border-gray-200 text-gray-700 whitespace-nowrap">{getDateFinCorrigee(proj)}
  {/* Affichage du retard en jours ou mois si projet en retard (date corrigée) */}
  {(() => {
    if (proj.fini) return null;
    const dateFinStr = getDateFinCorrigee(proj);
    if (!dateFinStr || dateFinStr === '-') return null;
    const [jour, mois, annee] = dateFinStr.split('/').map(Number);
    const dateFin = new Date(annee, mois - 1, jour);
    const now = new Date();
    dateFin.setHours(0,0,0,0);
    now.setHours(0,0,0,0);
    const diffJours = Math.ceil((now - dateFin) / (1000 * 60 * 60 * 24));
    if (diffJours > 0) {
      if (diffJours < 30) {
        return (
          <div className="text-xs text-red-600 font-bold mt-1">{diffJours} jour{diffJours > 1 ? 's' : ''} de retard</div>
        );
      } else {
        const moisRetard = Math.ceil(diffJours / 30);
        return (
          <div className="text-xs text-red-600 font-bold mt-1">{moisRetard} mois de retard</div>
        );
      }
    }
    return null;
  })()}
</td>
                      <td className="px-4 py-3 border-b border-gray-200 text-gray-700">{proj.devsAffectes.join(", ")}</td>
                      <td className="px-4 py-3 border-b border-gray-200 rounded-r-xl">
                        {proj.fini ? (
                          <span className="inline-block px-3 py-1 rounded-full bg-green-600/90 text-white text-xs font-bold">Livré</span>
                        ) : (
                          <button
                            className={
                              "px-3 py-1 rounded-full text-xs font-bold border-2 transition " +
                              "border-accent text-accent bg-accent/10 hover:bg-accent/20"
                            }
                            onClick={() => handleToggleFini(proj.id)}
                          >
                            Fini ?
                          </button>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <Modal
              open={modalOpen}
              onClose={handleModalClose}
              onConfirm={handleModalConfirm}
              message={modalTarget && (modalTarget.fini ? 'Marquer ce projet comme non fini ?' : 'Marquer ce projet comme fini ?')}
              requireDate={modalTarget && !modalTarget.fini}
              dateValue={modalDate}
              onDateChange={setModalDate}
            />
            <div className="text-xs text-gray-500 mt-2">* 1 sprint de marge est ajouté automatiquement à chaque projet.</div>
          </section>
        );
      }

      // Nouveau composant SprintList
      function SprintList({ sprints, setSprints }) {
        const [numero, setNumero] = React.useState("");
        const [dateDebut, setDateDebut] = React.useState("");
        const [dateFin, setDateFin] = React.useState("");
        const [editMode, setEditMode] = React.useState(false);
        const [editId, setEditId] = React.useState(null);

        function handleSubmit(e) {
          e.preventDefault();
          if (!numero || !dateDebut || !dateFin) return;
          if (editMode && editId !== null) {
            setSprints(sprints => sprints.map(s =>
              s.id === editId
                ? { ...s, numero: Number(numero), dateDebut, dateFin }
                : s
            ));
            setEditMode(false);
            setEditId(null);
          } else {
            setSprints(sprints => [
              ...sprints,
              {
                id: Date.now(),
                numero: Number(numero),
                dateDebut,
                dateFin,
              },
            ]);
          }
          setNumero("");
          setDateDebut("");
          setDateFin("");
        }

        function handleEdit(sprint) {
          setNumero(sprint.numero);
          setDateDebut(sprint.dateDebut);
          setDateFin(sprint.dateFin);
          setEditMode(true);
          setEditId(sprint.id);
        }

        function handleCancelEdit() {
          setEditMode(false);
          setEditId(null);
          setNumero("");
          setDateDebut("");
          setDateFin("");
        }

        function handleDelete(id) {
          if (window.confirm('Supprimer ce sprint ?')) {
            setSprints(sprints => sprints.filter(s => s.id !== id));
            if (editId === id) {
              setEditMode(false);
              setEditId(null);
              setNumero("");
              setDateDebut("");
              setDateFin("");
            }
          }
        }

        // Tri par numéro croissant
        const sprintsTries = [...sprints].sort((a, b) => a.numero - b.numero);

        function formatDateFR(dateStr) {
          if (!dateStr) return "-";
          try {
            return new Date(dateStr).toLocaleDateString('fr-FR');
          } catch {
            return dateStr;
          }
        }

        return (
          <section className="bg-white/90 p-8 rounded-2xl shadow-magic border border-accent/20 mb-8 transition-all duration-300 hover:shadow-xl">
            <h2 className="text-xl font-bold font-display text-accent mb-3 flex items-center gap-2">
              <svg className="w-6 h-6 text-primary" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" strokeWidth="2"/><path strokeLinecap="round" strokeLinejoin="round" d="M16 3v4M8 3v4M3 11h18" /></svg>
              Sprints (gestion manuelle)
            </h2>
            <form className="flex flex-col md:flex-row md:items-end gap-4 mb-6" onSubmit={handleSubmit}>
              <div>
                <label className="block text-sm font-semibold mb-1 text-gray-700">N° Sprint</label>
                <input type="number" min="1" className="w-24 border-2 border-accent/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-accent/40 transition h-10" value={numero} onChange={e => setNumero(e.target.value)} required />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-1 text-gray-700">Date début</label>
                <input type="date" className="w-44 border-2 border-accent/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-accent/40 transition h-10" value={dateDebut} onChange={e => setDateDebut(e.target.value)} required />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-1 text-gray-700">Date fin</label>
                <input type="date" className="w-44 border-2 border-accent/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-accent/40 transition h-10" value={dateFin} onChange={e => setDateFin(e.target.value)} required />
              </div>
              <button type="submit" className={"px-5 py-2 rounded-lg font-bold text-white shadow transition-all duration-200 " + (editMode ? "bg-primary hover:bg-primary/90" : "bg-accent hover:bg-accent/80")}>{editMode ? "Modifier" : "Ajouter"}</button>
              {editMode && (
                <button type="button" className="ml-2 px-4 py-2 rounded-lg font-semibold bg-gray-200 hover:bg-gray-300 text-gray-700 transition" onClick={handleCancelEdit}>Annuler</button>
              )}
            </form>
            <div>
              <h3 className="font-semibold mb-2 text-gray-700">Liste des sprints</h3>
              {sprintsTries.length === 0 ? (
                <div className="text-gray-400 italic">Aucun sprint saisi.</div>
              ) : (
                <ul className="divide-y">
                  {sprintsTries.map(sprint => (
                    <li key={sprint.id} className="py-2 flex items-center gap-4 group">
                      <span className="font-medium text-dark">Sprint {sprint.numero}</span>
                      <span className="text-sm text-accent font-semibold">{formatDateFR(sprint.dateDebut)} → {formatDateFR(sprint.dateFin)}</span>
                      <button type="button" className="ml-2 text-accent hover:text-primary font-bold opacity-70 group-hover:opacity-100 transition" title="Modifier" onClick={() => handleEdit(sprint)}>
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                      </button>
                      <button type="button" className="ml-2 text-red-400 hover:text-red-600 font-bold opacity-70 group-hover:opacity-100 transition" title="Supprimer" onClick={() => handleDelete(sprint.id)}>
                        <svg className="w-5 h-5" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                      </button>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </section>
        );
      }

      // Rendu principal
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html> 