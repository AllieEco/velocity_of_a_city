<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Velocity of a City</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Montserrat', 'sans-serif'],
            },
            colors: {
              primary: '#7C3AED', // violet
              accent: '#38BDF8', // bleu
              gold: '#FFD700',
              dark: '#18181B',
            },
            boxShadow: {
              magic: '0 8px 32px 0 rgba(124,58,237,0.25)',
            },
          },
        },
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f3e8ff 0%, #f9fafb 100%);
        min-height: 100vh;
      }
      .fade-in {
        animation: fadeIn 1s cubic-bezier(.39,.575,.565,1) both;
      }
      @keyframes fadeIn {
        0% { opacity: 0; transform: translateY(30px); }
        100% { opacity: 1; transform: none; }
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-primary/10 via-accent/10 to-white min-h-screen relative">
    <header class="w-full py-6 px-4 bg-white/80 backdrop-blur shadow-md fixed top-0 left-0 z-20 fade-in">
      <div class="max-w-5xl mx-auto flex items-center gap-4">
        <span class="inline-block bg-primary rounded-full p-2 shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2" />
            <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="#7C3AED" />
          </svg>
        </span>
        <div>
          <h1 class="text-3xl font-extrabold font-display text-primary tracking-tight">Dashboard</h1>
          <div class="text-sm text-gray-500 font-semibold">Vue synthétique et graphique du planning</div>
        </div>
        <a href="index.html" class="ml-auto px-5 py-2 rounded-lg font-bold text-white bg-accent hover:bg-primary transition shadow">Accueil</a>
      </div>
    </header>
    <main class="max-w-7xl mx-auto pt-32 pb-16 px-4 fade-in">
      <section class="bg-white/90 p-8 rounded-2xl shadow-magic border border-primary/10 mb-8 transition-all duration-300 hover:shadow-2xl">
        <h2 class="text-2xl font-bold font-display text-primary mb-4 flex items-center gap-2">
          <svg class="w-8 h-8 text-accent -mt-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" />
          </svg>
          Planning prévisionnel
        </h2>
        <div class="overflow-x-auto">
          <table class="min-w-full border-separate border-spacing-0 rounded-2xl shadow-lg bg-white">
            <thead>
              <tr class="bg-gradient-to-r from-primary/80 to-accent/80 text-white">
                <th class="px-4 py-3 text-left font-bold rounded-tl-2xl">Projet</th>
                <th class="px-4 py-3 text-left font-bold">Priorité</th>
                <th class="px-4 py-3 text-left font-bold">Points</th>
                <th class="px-4 py-3 text-left font-bold">Sprints nécessaires</th>
                <th class="px-4 py-3 text-left font-bold">Sprint début</th>
                <th class="px-4 py-3 text-left font-bold">Sprint fin</th>
                <th class="px-4 py-3 text-left font-bold">Date de fin prévisionnelle</th>
                <th class="px-4 py-3 text-left font-bold">Devs affectés</th>
                <th class="px-4 py-3 text-left font-bold rounded-tr-2xl">Fini ?</th>
              </tr>
            </thead>
            <tbody id="planningTableBody"></tbody>
          </table>
        </div>
      </section>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <section class="bg-white/90 p-6 rounded-2xl shadow-magic border border-primary/10 transition-all duration-300 hover:shadow-2xl">
          <h2 class="text-xl font-bold font-display text-primary mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" /></svg>
            Burndown Chart
          </h2>
          <canvas id="burndownChart" height="220"></canvas>
        </section>
        <section class="bg-white/90 p-6 rounded-2xl shadow-magic border border-accent/10 transition-all duration-300 hover:shadow-2xl">
          <h2 class="text-xl font-bold font-display text-accent mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" /></svg>
            Capacité de l’équipe par sprint
          </h2>
          <canvas id="capaciteChart" height="220"></canvas>
        </section>
        <section class="bg-white/90 p-6 rounded-2xl shadow-magic border border-gold/10 transition-all duration-300 hover:shadow-2xl">
          <h2 class="text-xl font-bold font-display text-gold mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-gold" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" /></svg>
            Répartition des points par développeur
          </h2>
          <canvas id="repartitionDevChart" height="180" width="320"></canvas>
        </section>
        <section class="bg-white/90 p-6 rounded-2xl shadow-magic border border-red-200 transition-all duration-300 hover:shadow-2xl">
          <h2 class="text-xl font-bold font-display text-red-500 mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" /></svg>
            Taux de livraison à temps
          </h2>
          <canvas id="livraisonChart" height="180" width="320"></canvas>
        </section>
      </div>
    </main>
    <footer class="w-full py-6 px-4 bg-white/80 backdrop-blur shadow-inner fixed bottom-0 left-0 z-10 fade-in">
      <div class="max-w-5xl mx-auto flex items-center justify-between text-sm text-gray-500">
        <span>© <span id="year"></span> <span class="font-bold text-primary">Velocity of a City</span></span>
        <span>Fait avec <span class="text-accent">♥</span> et beaucoup de <span class="text-gold">chocolat</span> !</span>
      </div>
    </footer>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const yearSpan = document.getElementById('year');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();
      });
      // Récupération des données depuis le localStorage
      const devs = JSON.parse(localStorage.getItem('devs') || '[]');
      const projects = JSON.parse(localStorage.getItem('projects') || '[]');
      const sprints = JSON.parse(localStorage.getItem('sprints') || '[]');

      // 1. Burndown Chart (points restants par sprint)
      function getBurndownData() {
        // On simule le calcul du planning comme dans l'app principale
        const POINTS_PAR_STATUT = {
          'Débutant': 30,
          'Junior': 45,
          'Confirmé': 60,
          'Senior': 75,
        };
        function getPointsDispo(dev, sprintIndex) {
          // On cherche la date du sprint
          if (!sprints[sprintIndex]) return 0;
          const sprint = sprints[sprintIndex];
          // On additionne les absences qui touchent ce sprint
          let totalAbs = 0;
          Object.entries(dev.absences || {}).forEach(([date, nb]) => {
            const dateDebutAbs = new Date(date);
            const dateFinAbs = new Date(date);
            dateFinAbs.setDate(dateFinAbs.getDate() + Number(nb) - 1);
            const sprintDeb = new Date(sprint.dateDebut);
            const sprintFin = new Date(sprint.dateFin);
            if (
              (dateDebutAbs <= sprintFin && dateDebutAbs >= sprintDeb) ||
              (dateFinAbs >= sprintDeb && dateFinAbs <= sprintFin) ||
              (dateDebutAbs <= sprintDeb && dateFinAbs >= sprintFin)
            ) {
              // On compte le nombre de jours d'absence qui tombent sur ce sprint
              const absDeb = dateDebutAbs < sprintDeb ? sprintDeb : dateDebutAbs;
              const absFin = dateFinAbs > sprintFin ? sprintFin : dateFinAbs;
              const jours = Math.max(0, (absFin - absDeb) / (1000*60*60*24) + 1);
              totalAbs += jours;
            }
          });
          const base = POINTS_PAR_STATUT[dev.statut] || 0;
          const sprintDays = Math.max(1, (new Date(sprint.dateFin) - new Date(sprint.dateDebut)) / (1000*60*60*24) + 1);
          const ratio = Math.max(0, 1 - totalAbs / sprintDays);
          return Math.round(base * ratio);
        }
        // Points totaux à faire
        const totalPoints = projects.reduce((sum, p) => sum + (p.points || 0), 0);
        let pointsRestants = totalPoints;
        const data = [];
        for (let i = 0; i < sprints.length; i++) {
          // Capacité de l'équipe ce sprint
          const cap = devs.reduce((sum, dev) => sum + getPointsDispo(dev, i), 0);
          pointsRestants -= cap;
          data.push(pointsRestants < 0 ? 0 : pointsRestants);
        }
        return data;
      }

      // 2. Capacité de l’équipe par sprint
      function getCapaciteData() {
        const POINTS_PAR_STATUT = {
          'Débutant': 30,
          'Junior': 45,
          'Confirmé': 60,
          'Senior': 75,
        };
        function getPointsDispo(dev, sprintIndex) {
          if (!sprints[sprintIndex]) return 0;
          const sprint = sprints[sprintIndex];
          let totalAbs = 0;
          Object.entries(dev.absences || {}).forEach(([date, nb]) => {
            const dateDebutAbs = new Date(date);
            const dateFinAbs = new Date(date);
            dateFinAbs.setDate(dateFinAbs.getDate() + Number(nb) - 1);
            const sprintDeb = new Date(sprint.dateDebut);
            const sprintFin = new Date(sprint.dateFin);
            if (
              (dateDebutAbs <= sprintFin && dateDebutAbs >= sprintDeb) ||
              (dateFinAbs >= sprintDeb && dateFinAbs <= sprintFin) ||
              (dateDebutAbs <= sprintDeb && dateFinAbs >= sprintFin)
            ) {
              const absDeb = dateDebutAbs < sprintDeb ? sprintDeb : dateDebutAbs;
              const absFin = dateFinAbs > sprintFin ? sprintFin : dateFinAbs;
              const jours = Math.max(0, (absFin - absDeb) / (1000*60*60*24) + 1);
              totalAbs += jours;
            }
          });
          const base = POINTS_PAR_STATUT[dev.statut] || 0;
          const sprintDays = Math.max(1, (new Date(sprint.dateFin) - new Date(sprint.dateDebut)) / (1000*60*60*24) + 1);
          const ratio = Math.max(0, 1 - totalAbs / sprintDays);
          return Math.round(base * ratio);
        }
        return sprints.map((s, i) => devs.reduce((sum, dev) => sum + getPointsDispo(dev, i), 0));
      }

      // 3. Répartition des points par développeur
      function getRepartitionDevData() {
        // On additionne tous les points affectés à chaque dev (tous projets)
        const devPoints = devs.map(dev => ({
          nom: dev.prenom + ' ' + dev.nom,
          points: 0
        }));
        projects.forEach(proj => {
          if (proj.devsAffectesIds && proj.devsAffectesIds.length > 0) {
            proj.devsAffectesIds.forEach(id => {
              const idx = devs.findIndex(d => d.id === id);
              if (idx !== -1) devPoints[idx].points += proj.points || 0;
            });
          } else {
            // Si aucun dev affecté, tous les devs sont concernés
            devPoints.forEach(dp => { dp.points += (proj.points || 0) / devPoints.length; });
          }
        });
        return devPoints;
      }

      // 4. Taux de livraison à temps
      function getLivraisonData() {
        let livret = 0, retard = 0;
        projects.forEach(p => {
          if (!p.fini || !p.dateDebut || !p.dateFin) return;
          // Date de fin prévisionnelle
          const SPRINT_DAYS = 10;
          const sprintsCount = p.sprints || 1;
          const d = new Date(p.dateDebut);
          const totalDays = sprintsCount * (SPRINT_DAYS + 2);
          d.setDate(d.getDate() + totalDays);
          d.setHours(0,0,0,0);
          // Date de livraison réelle
          const dateLivraison = new Date(p.dateFin);
          dateLivraison.setHours(0,0,0,0);
          if (dateLivraison <= d) {
            livret++;
          } else {
            retard++;
          }
        });
        return [livret, retard];
      }

      // Labels sprints
      const sprintLabels = sprints.map(s => 'Sprint ' + s.numero);

      // 1. Burndown Chart
      new Chart(document.getElementById('burndownChart'), {
        type: 'line',
        data: {
          labels: sprintLabels,
          datasets: [{
            label: 'Points restants',
            data: getBurndownData(),
            borderColor: '#7C3AED',
            backgroundColor: '#7C3AED22',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: '#7C3AED',
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Points restants' } },
            x: { title: { display: true, text: 'Sprint' } }
          }
        }
      });

      // 2. Capacité de l’équipe par sprint
      new Chart(document.getElementById('capaciteChart'), {
        type: 'bar',
        data: {
          labels: sprintLabels,
          datasets: [{
            label: 'Capacité (pts)',
            data: getCapaciteData(),
            backgroundColor: '#38BDF8',
            borderColor: '#38BDF8',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Points disponibles' } },
            x: { title: { display: true, text: 'Sprint' } }
          }
        }
      });

      // 3. Répartition des points par développeur
      const repartitionData = getRepartitionDevData();
      new Chart(document.getElementById('repartitionDevChart'), {
        type: 'pie',
        data: {
          labels: repartitionData.map(d => d.nom),
          datasets: [{
            label: 'Points',
            data: repartitionData.map(d => d.points),
            backgroundColor: [
              '#7C3AED', '#38BDF8', '#FFD700', '#18181B', '#F472B6', '#34D399', '#F59E42', '#6366F1'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: false }
          }
        }
      });

      // 4. Taux de livraison à temps
      const livraisonData = getLivraisonData();
      new Chart(document.getElementById('livraisonChart'), {
        type: 'doughnut',
        data: {
          labels: ['Livrés à temps', 'Livrés en retard'],
          datasets: [{
            data: livraisonData,
            backgroundColor: ['#34D399', '#F87171'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: false }
          }
        }
      });

      // Remplacer la fonction genererPlanning par la vraie version de index.html
      function genererPlanning(devs, projects) {
        const POINTS_PAR_STATUT = {
          'Débutant': 30,
          'Junior': 45,
          'Confirmé': 60,
          'Senior': 75,
        };
        const SPRINT_DAYS = 10;
        // Tri des projets par priorité croissante
        const projetsTries = [...projects].sort((a, b) => a.priorite - b.priorite);
        let sprintIndex = 0;
        let projetsRestants = projetsTries.map(p => ({ ...p, pointsRestants: p.points, debut: null, fin: null, sprints: 0, devsAffectes: [] }));
        let devsState = devs.map(dev => ({ ...dev }));
        // On boucle tant qu’il reste des projets à finir
        while (projetsRestants.some(p => p.pointsRestants > 0)) {
          // Pour chaque projet, dans l’ordre de priorité
          for (let projet of projetsRestants) {
            if (projet.pointsRestants <= 0) continue;
            if (projet.debut === null) projet.debut = sprintIndex;
            let pointsAffectes = 0;
            // Déterminer les devs à utiliser pour ce projet
            let devsPourProjet = Array.isArray(projet.devsAffectesIds) && projet.devsAffectesIds.length > 0
              ? devsState.filter(d => projet.devsAffectesIds.includes(d.id))
              : devsState;
            // Capacité dispo ce sprint pour ces devs
            const dispoSprint = devsPourProjet.map(dev => ({
              ...dev,
              pointsDispo: POINTS_PAR_STATUT[dev.statut] || 0,
            }));
            // Répartition sur les devs affectés
            for (let dev of dispoSprint) {
              if (dev.pointsDispo <= 0 || projet.pointsRestants <= 0) continue;
              const pointsPourCeDev = Math.min(dev.pointsDispo, projet.pointsRestants);
              dev.pointsDispo -= pointsPourCeDev;
              projet.pointsRestants -= pointsPourCeDev;
              pointsAffectes += pointsPourCeDev;
              if (!projet.devsAffectes.includes(dev.nom)) projet.devsAffectes.push(dev.nom);
            }
            if (pointsAffectes > 0) projet.sprints++;
            if (projet.pointsRestants <= 0 && projet.fin === null) projet.fin = sprintIndex;
          }
          sprintIndex++;
        }
        // Ajout d’une marge de 1 sprint par projet
        for (let projet of projetsRestants) {
          projet.sprints += 1;
          projet.fin = (projet.fin ?? 0) + 1;
        }
        return projetsRestants;
      }
      // Fonction utilitaire pour la date de fin prévisionnelle
      function getDateFin(proj) {
        if (!proj.dateDebut) return "-";
        const SPRINT_DAYS = 10;
        const d = new Date(proj.dateDebut);
        const totalDays = proj.sprints * (SPRINT_DAYS + 2);
        d.setDate(d.getDate() + totalDays);
        return d.toLocaleDateString('fr-FR');
      }
      // Affichage du planning dans le tableau
      function renderPlanningTable() {
        const planning = genererPlanning(devs, projects);
        const projectsById = Object.fromEntries(projects.map(p => [p.id, p]));
        const tbody = document.getElementById('planningTableBody');
        tbody.innerHTML = '';
        planning.forEach((proj, idx) => {
          const p = projectsById[proj.id] || {};
          let rowClass = "transition hover:bg-accent/10 ";
          if (p.fini) rowClass += "bg-green-50 ";
          else {
            // On parse la date de fin prévisionnelle
            const dateFinStr = getDateFin(proj);
            if (dateFinStr && dateFinStr !== '-') {
              const [jour, mois, annee] = dateFinStr.split('/').map(Number);
              const dateFin = new Date(annee, mois - 1, jour);
              const now = new Date();
              dateFin.setHours(0,0,0,0);
              now.setHours(0,0,0,0);
              const diffJours = Math.ceil((dateFin - now) / (1000 * 60 * 60 * 24));
              if (diffJours < 0) rowClass += 'bg-red-50 ';
              else if (diffJours <= 7) rowClass += 'bg-orange-50 ';
              else rowClass += (idx % 2 === 0 ? 'bg-gray-50 ' : 'bg-white ');
            } else {
              rowClass += (idx % 2 === 0 ? 'bg-gray-50 ' : 'bg-white ');
            }
          }
          const tr = document.createElement('tr');
          tr.className = rowClass;
          tr.innerHTML = `
            <td class="px-4 py-3 font-semibold text-dark text-base rounded-l-xl border-b border-gray-200">${proj.nom}</td>
            <td class="px-4 py-3 border-b border-gray-200">
              <span class="inline-block px-2 py-1 rounded-full text-xs font-bold ${proj.priorite === 1 ? 'bg-primary/90 text-white' : proj.priorite === 2 ? 'bg-accent/90 text-white' : 'bg-gray-200 text-gray-700'}">${proj.priorite}</span>
            </td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700 font-medium">${proj.points}</td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700 font-medium">${proj.sprints}</td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700">${proj.debut + 1}</td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700">${proj.fin + 1}</td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700 whitespace-nowrap">${getDateFin(proj)}</td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700">${(proj.devsAffectes || []).join(', ')}</td>
            <td class="px-4 py-3 border-b border-gray-200 rounded-r-xl">${p.fini ? '<span class="inline-block px-3 py-1 rounded-full bg-green-600/90 text-white text-xs font-bold">Livré</span>' : '<span class="inline-block px-3 py-1 rounded-full border-2 border-accent text-accent bg-accent/10 text-xs font-bold">En cours</span>'}</td>
          `;
          tbody.appendChild(tr);
        });
      }
      document.addEventListener('DOMContentLoaded', renderPlanningTable);
    </script>
  </body>
</html> 