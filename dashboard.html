<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Velocity of a City</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
              display: ['Montserrat', 'sans-serif'],
            },
            colors: {
              primary: '#7C3AED', // violet
              accent: '#38BDF8', // bleu
              gold: '#FFD700',
              dark: '#18181B',
            },
            boxShadow: {
              magic: '0 8px 32px 0 rgba(124,58,237,0.25)',
            },
          },
        },
      }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(135deg, #f3e8ff 0%, #f9fafb 100%);
        min-height: 100vh;
      }
      .fade-in {
        animation: fadeIn 1s cubic-bezier(.39,.575,.565,1) both;
      }
      @keyframes fadeIn {
        0% { opacity: 0; transform: translateY(30px); }
        100% { opacity: 1; transform: none; }
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-primary/10 via-accent/10 to-white min-h-screen relative">
    <header class="w-full py-6 px-4 bg-white/80 backdrop-blur shadow-md fixed top-0 left-0 z-20 fade-in">
      <div class="max-w-5xl mx-auto flex items-center gap-4">
        <span class="inline-block bg-primary rounded-full p-2 shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="white" class="w-8 h-8">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2" />
            <circle cx="12" cy="12" r="10" stroke="white" stroke-width="2" fill="#7C3AED" />
          </svg>
        </span>
        <div>
          <h1 class="text-3xl font-extrabold font-display text-primary tracking-tight">Dashboard</h1>
          <div class="text-sm text-gray-500 font-semibold">Vue synth√©tique et graphique du planning</div>
        </div>
        <a href="index.html" class="ml-auto px-5 py-2 rounded-lg font-bold text-white bg-accent hover:bg-primary transition shadow">Accueil</a>
      </div>
    </header>
    <main class="max-w-7xl mx-auto pt-32 pb-16 px-4 fade-in">
      <section class="bg-white/90 p-8 rounded-2xl shadow-magic border border-primary/10 mb-8 transition-all duration-300 hover:shadow-2xl">
        <h2 class="text-2xl font-bold font-display text-primary mb-4 flex items-center gap-2">
          <svg class="w-8 h-8 text-accent -mt-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" />
          </svg>
          Planning pr√©visionnel
        </h2>
        <!-- Filtres -->
        <div class="flex flex-wrap gap-4 mb-6 items-end">
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">Priorit√©</label>
            <select id="filtrePriorite" class="border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition bg-white shadow-sm">
              <option value="">Toutes</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">√âtat</label>
            <select id="filtreEtat" class="border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition bg-white shadow-sm">
              <option value="">Tous</option>
              <option value="en_cours">En cours</option>
              <option value="bientot_retard">Bient√¥t en retard</option>
              <option value="retard">En retard</option>
              <option value="livre">Livr√©</option>
            </select>
          </div>
          <div>
            <label class="block text-xs font-semibold text-gray-600 mb-1">D√©veloppeur</label>
            <select id="filtreDev" class="border-2 border-primary/20 rounded-lg px-3 py-2 focus:ring-2 focus:ring-primary/40 transition bg-white shadow-sm">
              <option value="">Tous</option>
            </select>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full border-separate border-spacing-0 rounded-2xl shadow-lg bg-white">
            <thead>
              <tr class="bg-gradient-to-r from-primary/80 to-accent/80 text-white">
                <th class="px-4 py-3 text-left font-bold rounded-tl-2xl">Projet</th>
                <th class="px-4 py-3 text-left font-bold">Statut</th>
                <th class="px-4 py-3 text-left font-bold">Priorit√©</th>
                <th class="px-4 py-3 text-left font-bold">Points</th>
                <th class="px-4 py-3 text-left font-bold">Sprints n√©cessaires</th>
                <th class="px-4 py-3 text-left font-bold">Date de fin pr√©visionnelle</th>
                <th class="px-4 py-3 text-left font-bold">Devs affect√©s</th>
                <th class="px-4 py-3 text-left font-bold rounded-tr-2xl">Fini ?</th>
              </tr>
            </thead>
            <tbody id="planningTableBody"></tbody>
          </table>
        </div>
        <div class="text-xs text-gray-500 mt-2">* 1 sprint de marge est ajout√© automatiquement √† chaque projet.</div>
      </section>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <section class="bg-white/90 p-6 rounded-2xl shadow-magic border border-primary/10 transition-all duration-300 hover:shadow-2xl">
          <h2 class="text-xl font-bold font-display text-primary mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" /></svg>
            Burndown Chart
          </h2>
          <canvas id="burndownChart" height="220"></canvas>
        </section>
        <section class="bg-white/90 p-6 rounded-2xl shadow-magic border border-accent/10 transition-all duration-300 hover:shadow-2xl">
          <h2 class="text-xl font-bold font-display text-accent mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" /></svg>
            Capacit√© de l‚Äô√©quipe par sprint
          </h2>
          <canvas id="capaciteChart" height="220"></canvas>
        </section>
        <section class="bg-white/90 p-6 rounded-2xl shadow-magic border border-gold/10 transition-all duration-300 hover:shadow-2xl">
          <h2 class="text-xl font-bold font-display text-gold mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-gold" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" /></svg>
            R√©partition des points par d√©veloppeur
          </h2>
          <canvas id="repartitionDevChart" height="180" width="320"></canvas>
        </section>
        <section class="bg-white/90 p-6 rounded-2xl shadow-magic border border-red-200 transition-all duration-300 hover:shadow-2xl">
          <h2 class="text-xl font-bold font-display text-red-500 mb-4 flex items-center gap-2">
            <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="13" rx="2" stroke="currentColor" stroke-width="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 3v4M8 3v4M3 11h18" /></svg>
            Taux de livraison √† temps
          </h2>
          <canvas id="livraisonChart" height="180" width="320"></canvas>
        </section>
      </div>
    </main>
    <footer class="w-full py-6 px-4 bg-white/80 backdrop-blur shadow-inner fixed bottom-0 left-0 z-10 fade-in">
      <div class="max-w-5xl mx-auto flex items-center justify-between text-sm text-gray-500">
        <span>¬© <span id="year"></span> <span class="font-bold text-primary">Velocity of a City</span></span>
        <span>Fait avec <span class="text-accent">‚ô•</span> et beaucoup de <span class="text-gold">chocolat</span> !</span>
      </div>
    </footer>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        const yearSpan = document.getElementById('year');
        if (yearSpan) yearSpan.textContent = new Date().getFullYear();
      });
      // R√©cup√©ration des donn√©es depuis le localStorage
      const devs = JSON.parse(localStorage.getItem('devs') || '[]');
      const projects = JSON.parse(localStorage.getItem('projects') || '[]');
      const sprints = JSON.parse(localStorage.getItem('sprints') || '[]');

      // Statuts de projet avec leurs couleurs
      const STATUTS_PROJET = {
        'conception': { color: 'bg-indigo-100 text-indigo-800 border-indigo-200', icon: 'üé®', label: 'Conception' },
        'dev': { color: 'bg-blue-100 text-blue-800 border-blue-200', icon: 'üíª', label: 'D√©veloppement' },
        'test': { color: 'bg-yellow-100 text-yellow-800 border-yellow-200', icon: 'üß™', label: 'Test' },
        'review': { color: 'bg-purple-100 text-purple-800 border-purple-200', icon: 'üëÄ', label: 'Review' },
        'deploy': { color: 'bg-green-100 text-green-800 border-green-200', icon: 'üöÄ', label: 'D√©ploiement' }
      };

      // 1. Burndown Chart (points restants par sprint)
      function getBurndownData() {
        // On simule le calcul du planning comme dans l'app principale
        const POINTS_PAR_STATUT = {
          'D√©butant': 30,
          'Junior': 45,
          'Confirm√©': 60,
          'Senior': 75,
        };
        function getPointsDispo(dev, sprintIndex) {
          // On cherche la date du sprint
          if (!sprints[sprintIndex]) return 0;
          const sprint = sprints[sprintIndex];
          // On additionne les absences qui touchent ce sprint
          let totalAbs = 0;
          Object.entries(dev.absences || {}).forEach(([date, nb]) => {
            const dateDebutAbs = new Date(date);
            const dateFinAbs = new Date(date);
            dateFinAbs.setDate(dateFinAbs.getDate() + Number(nb) - 1);
            const sprintDeb = new Date(sprint.dateDebut);
            const sprintFin = new Date(sprint.dateFin);
            if (
              (dateDebutAbs <= sprintFin && dateDebutAbs >= sprintDeb) ||
              (dateFinAbs >= sprintDeb && dateFinAbs <= sprintFin) ||
              (dateDebutAbs <= sprintDeb && dateFinAbs >= sprintFin)
            ) {
              // On compte le nombre de jours d'absence qui tombent sur ce sprint
              const absDeb = dateDebutAbs < sprintDeb ? sprintDeb : dateDebutAbs;
              const absFin = dateFinAbs > sprintFin ? sprintFin : dateFinAbs;
              const jours = Math.max(0, (absFin - absDeb) / (1000*60*60*24) + 1);
              totalAbs += jours;
            }
          });
          const base = POINTS_PAR_STATUT[dev.statut] || 0;
          const sprintDays = Math.max(1, (new Date(sprint.dateFin) - new Date(sprint.dateDebut)) / (1000*60*60*24) + 1);
          const ratio = Math.max(0, 1 - totalAbs / sprintDays);
          return Math.round(base * ratio);
        }
        // Points totaux √† faire
        const totalPoints = projects.reduce((sum, p) => sum + (p.points || 0), 0);
        let pointsRestants = totalPoints;
        const data = [];
        for (let i = 0; i < sprints.length; i++) {
          // Capacit√© de l'√©quipe ce sprint
          const cap = devs.reduce((sum, dev) => sum + getPointsDispo(dev, i), 0);
          pointsRestants -= cap;
          data.push(pointsRestants < 0 ? 0 : pointsRestants);
        }
        return data;
      }

      // 2. Capacit√© de l‚Äô√©quipe par sprint
      function getCapaciteData() {
        const POINTS_PAR_STATUT = {
          'D√©butant': 30,
          'Junior': 45,
          'Confirm√©': 60,
          'Senior': 75,
        };
        function getPointsDispo(dev, sprintIndex) {
          if (!sprints[sprintIndex]) return 0;
          const sprint = sprints[sprintIndex];
          let totalAbs = 0;
          Object.entries(dev.absences || {}).forEach(([date, nb]) => {
            const dateDebutAbs = new Date(date);
            const dateFinAbs = new Date(date);
            dateFinAbs.setDate(dateFinAbs.getDate() + Number(nb) - 1);
            const sprintDeb = new Date(sprint.dateDebut);
            const sprintFin = new Date(sprint.dateFin);
            if (
              (dateDebutAbs <= sprintFin && dateDebutAbs >= sprintDeb) ||
              (dateFinAbs >= sprintDeb && dateFinAbs <= sprintFin) ||
              (dateDebutAbs <= sprintDeb && dateFinAbs >= sprintFin)
            ) {
              const absDeb = dateDebutAbs < sprintDeb ? sprintDeb : dateDebutAbs;
              const absFin = dateFinAbs > sprintFin ? sprintFin : dateFinAbs;
              const jours = Math.max(0, (absFin - absDeb) / (1000*60*60*24) + 1);
              totalAbs += jours;
            }
          });
          const base = POINTS_PAR_STATUT[dev.statut] || 0;
          const sprintDays = Math.max(1, (new Date(sprint.dateFin) - new Date(sprint.dateDebut)) / (1000*60*60*24) + 1);
          const ratio = Math.max(0, 1 - totalAbs / sprintDays);
          return Math.round(base * ratio);
        }
        return sprints.map((s, i) => devs.reduce((sum, dev) => sum + getPointsDispo(dev, i), 0));
      }

      // 3. R√©partition des points par d√©veloppeur
      function getRepartitionDevData() {
        // On additionne tous les points affect√©s √† chaque dev (tous projets)
        const devPoints = devs.map(dev => ({
          nom: dev.prenom + ' ' + dev.nom,
          points: 0
        }));
        projects.forEach(proj => {
          if (proj.devsAffectesIds && proj.devsAffectesIds.length > 0) {
            proj.devsAffectesIds.forEach(id => {
              const idx = devs.findIndex(d => d.id === id);
              if (idx !== -1) devPoints[idx].points += proj.points || 0;
            });
          } else {
            // Si aucun dev affect√©, tous les devs sont concern√©s
            devPoints.forEach(dp => { dp.points += (proj.points || 0) / devPoints.length; });
          }
        });
        return devPoints;
      }

      // 4. Taux de livraison √† temps
      function getLivraisonData() {
        let livret = 0, retard = 0;
        projects.forEach(p => {
          if (!p.fini || !p.dateDebut || !p.dateFin) return;
          // Date de fin pr√©visionnelle
          const SPRINT_DAYS = 10;
          const sprintsCount = p.sprints || 1;
          const d = new Date(p.dateDebut);
          const totalDays = sprintsCount * (SPRINT_DAYS + 2);
          d.setDate(d.getDate() + totalDays);
          d.setHours(0,0,0,0);
          // Date de livraison r√©elle
          const dateLivraison = new Date(p.dateFin);
          dateLivraison.setHours(0,0,0,0);
          if (dateLivraison <= d) {
            livret++;
          } else {
            retard++;
          }
        });
        return [livret, retard];
      }

      // Labels sprints
      const sprintLabels = sprints.map(s => 'Sprint ' + s.numero);

      // 1. Burndown Chart
      new Chart(document.getElementById('burndownChart'), {
        type: 'line',
        data: {
          labels: sprintLabels,
          datasets: [{
            label: 'Points restants',
            data: getBurndownData(),
            borderColor: '#7C3AED',
            backgroundColor: '#7C3AED22',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointBackgroundColor: '#7C3AED',
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Points restants' } },
            x: { title: { display: true, text: 'Sprint' } }
          }
        }
      });

      // 2. Capacit√© de l‚Äô√©quipe par sprint
      new Chart(document.getElementById('capaciteChart'), {
        type: 'bar',
        data: {
          labels: sprintLabels,
          datasets: [{
            label: 'Capacit√© (pts)',
            data: getCapaciteData(),
            backgroundColor: '#38BDF8',
            borderColor: '#38BDF8',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Points disponibles' } },
            x: { title: { display: true, text: 'Sprint' } }
          }
        }
      });

      // 3. R√©partition des points par d√©veloppeur
      const repartitionData = getRepartitionDevData();
      new Chart(document.getElementById('repartitionDevChart'), {
        type: 'pie',
        data: {
          labels: repartitionData.map(d => d.nom),
          datasets: [{
            label: 'Points',
            data: repartitionData.map(d => d.points),
            backgroundColor: [
              '#7C3AED', '#38BDF8', '#FFD700', '#18181B', '#F472B6', '#34D399', '#F59E42', '#6366F1'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: false }
          }
        }
      });

      // 4. Taux de livraison √† temps
      const livraisonData = getLivraisonData();
      new Chart(document.getElementById('livraisonChart'), {
        type: 'doughnut',
        data: {
          labels: ['Livr√©s √† temps', 'Livr√©s en retard'],
          datasets: [{
            data: livraisonData,
            backgroundColor: ['#34D399', '#F87171'],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            title: { display: false }
          }
        }
      });

      // Remplacer la fonction genererPlanning par la vraie version de index.html
      function genererPlanning(devs, projects) {
        const POINTS_PAR_STATUT = {
          'D√©butant': 30,
          'Junior': 45,
          'Confirm√©': 60,
          'Senior': 75,
        };
        const SPRINT_DAYS = 10;
        // Tri des projets par priorit√© croissante
        const projetsTries = [...projects].sort((a, b) => a.priorite - b.priorite);
        let sprintIndex = 0;
        let projetsRestants = projetsTries.map(p => ({ ...p, pointsRestants: p.points, debut: null, fin: null, sprints: 0, devsAffectes: [] }));
        let devsState = devs.map(dev => ({ ...dev }));
        // On boucle tant qu‚Äôil reste des projets √† finir
        while (projetsRestants.some(p => p.pointsRestants > 0)) {
          // Pour chaque projet, dans l‚Äôordre de priorit√©
          for (let projet of projetsRestants) {
            if (projet.pointsRestants <= 0) continue;
            if (projet.debut === null) projet.debut = sprintIndex;
            let pointsAffectes = 0;
            // D√©terminer les devs √† utiliser pour ce projet
            let devsPourProjet = Array.isArray(projet.devsAffectesIds) && projet.devsAffectesIds.length > 0
              ? devsState.filter(d => projet.devsAffectesIds.includes(d.id))
              : devsState;
            // Capacit√© dispo ce sprint pour ces devs
            const dispoSprint = devsPourProjet.map(dev => ({
              ...dev,
              pointsDispo: POINTS_PAR_STATUT[dev.statut] || 0,
            }));
            // R√©partition sur les devs affect√©s
            for (let dev of dispoSprint) {
              if (dev.pointsDispo <= 0 || projet.pointsRestants <= 0) continue;
              const pointsPourCeDev = Math.min(dev.pointsDispo, projet.pointsRestants);
              dev.pointsDispo -= pointsPourCeDev;
              projet.pointsRestants -= pointsPourCeDev;
              pointsAffectes += pointsPourCeDev;
              if (!projet.devsAffectes.includes(dev.nom)) projet.devsAffectes.push(dev.nom);
            }
            if (pointsAffectes > 0) projet.sprints++;
            if (projet.pointsRestants <= 0 && projet.fin === null) projet.fin = sprintIndex;
          }
          sprintIndex++;
        }
        // Ajout d‚Äôune marge de 1 sprint par projet
        for (let projet of projetsRestants) {
          projet.sprints += 1;
          projet.fin = (projet.fin ?? 0) + 1;
        }
        return projetsRestants;
      }
      // Fonction utilitaire pour la date de fin pr√©visionnelle
      function getDateFin(proj) {
        if (!proj.dateDebut) return "-";
        const SPRINT_DAYS = 10;
        const d = new Date(proj.dateDebut);
        const totalDays = proj.sprints * (SPRINT_DAYS + 2);
        d.setDate(d.getDate() + totalDays);
        return d.toLocaleDateString('fr-FR');
      }
      // Fonction getPointsDispo am√©lior√©e (version de l'index)
      function getPointsDispo(dev, sprintIndex) {
        const POINTS_PAR_STATUT = {
          'D√©butant': 30,
          'Junior': 45,
          'Confirm√©': 60,
          'Senior': 75,
        };
        const SPRINT_DAYS = 10;
        const base = POINTS_PAR_STATUT[dev.statut] || 0;
        const absenceData = dev.absences?.[sprintIndex];
        const abs = typeof absenceData === 'number' ? absenceData : (absenceData?.jours || 0);
        const ratio = Math.max(0, 1 - abs / SPRINT_DAYS);
        return Math.round(base * ratio);
      }

      // Fonction genererPlanning compl√®te (version de l'index)
      function genererPlanning(devs, projects) {
        const POINTS_PAR_STATUT = {
          'D√©butant': 30,
          'Junior': 45,
          'Confirm√©': 60,
          'Senior': 75,
        };
        const SPRINT_DAYS = 10;
        
        // Tri des projets par priorit√© croissante
        const projetsTries = [...projects].sort((a, b) => a.priorite - b.priorite);
        let sprintIndex = 0;
        let projetsRestants = projetsTries.map(p => ({ ...p, pointsRestants: p.points, debut: null, fin: null, sprints: 0, devsAffectes: [] }));

        // On boucle tant qu'il reste des projets √† finir
        while (projetsRestants.some(p => p.pointsRestants > 0)) {
          // R√©initialiser les points disponibles pour ce sprint
          let devsState = devs.map(dev => ({
            ...dev,
            pointsDispo: getPointsDispo(dev, sprintIndex)
          }));

          // Premi√®re passe : identifier tous les projets actifs ce sprint
          let projetsActifs = projetsRestants.filter(p => p.pointsRestants > 0);
          
          // Deuxi√®me passe : r√©partition intelligente bas√©e sur les priorit√©s
          for (let projet of projetsActifs) {
            if (projet.pointsRestants <= 0) continue;
            if (projet.debut === null) projet.debut = sprintIndex;
            let pointsAffectes = 0;
            
            // D√©terminer les devs √† utiliser pour ce projet
            let devsPourProjet = Array.isArray(projet.devsAffectesIds) && projet.devsAffectesIds.length > 0
              ? devsState.filter(d => projet.devsAffectesIds.includes(d.id))
              : devsState;
            
            // R√©partition intelligente sur les devs affect√©s
            for (let dev of devsPourProjet) {
              if (dev.pointsDispo <= 0 || projet.pointsRestants <= 0) continue;
              
              // Identifier tous les projets actifs sur ce dev
              let projetsSurCeDev = projetsActifs.filter(p => {
                if (p.pointsRestants <= 0) return false;
                let devsDuProjet = Array.isArray(p.devsAffectesIds) && p.devsAffectesIds.length > 0
                  ? devsState.filter(d => p.devsAffectesIds.includes(d.id))
                  : devsState;
                return devsDuProjet.some(d => d.id === dev.id);
              });
              
              // Grouper les projets par priorit√©
              let projetsParPriorite = {};
              projetsSurCeDev.forEach(p => {
                if (!projetsParPriorite[p.priorite]) {
                  projetsParPriorite[p.priorite] = [];
                }
                projetsParPriorite[p.priorite].push(p);
              });
              
              let pointsPourCeDev = 0;
              const priorites = Object.keys(projetsParPriorite).map(Number).sort((a, b) => a - b);
              
              // Logique de r√©partition bas√©e sur les priorit√©s
              if (priorites.length === 1) {
                // M√™me priorit√© : r√©partition √©quitable
                const nbProjets = projetsParPriorite[priorites[0]].length;
                pointsPourCeDev = Math.floor(dev.pointsDispo / nbProjets);
              } else if (priorites.length === 2) {
                const prioriteHaute = priorites[0];
                const prioriteBasse = priorites[1];
                
                if (prioriteHaute === 1 && prioriteBasse === 3) {
                  // Priorit√© 1 vs 3 : s√©quentiel (priorit√© 1 d'abord)
                  if (projet.priorite === 1) {
                    pointsPourCeDev = dev.pointsDispo; // 100% pour priorit√© 1
                  } else {
                    pointsPourCeDev = 0; // 0% pour priorit√© 3 (attendre)
                  }
                } else {
                  // Autres cas : 80/20
                  if (projet.priorite === prioriteHaute) {
                    pointsPourCeDev = Math.floor(dev.pointsDispo * 0.8);
                  } else {
                    pointsPourCeDev = Math.floor(dev.pointsDispo * 0.2);
                  }
                }
              } else {
                // Plus de 2 priorit√©s : priorit√© la plus haute d'abord
                const prioriteMin = Math.min(...priorites);
                if (projet.priorite === prioriteMin) {
                  pointsPourCeDev = dev.pointsDispo; // 100% pour priorit√© la plus haute
                } else {
                  pointsPourCeDev = 0; // 0% pour les autres (attendre)
                }
              }
              
              // Appliquer les limites
              pointsPourCeDev = Math.min(pointsPourCeDev, projet.pointsRestants, dev.pointsDispo);
              
              dev.pointsDispo -= pointsPourCeDev;
              projet.pointsRestants -= pointsPourCeDev;
              pointsAffectes += pointsPourCeDev;
              if (!projet.devsAffectes.includes(dev.nom)) projet.devsAffectes.push(dev.nom);
            }
            
            if (pointsAffectes > 0) projet.sprints++;
            if (projet.pointsRestants <= 0 && projet.fin === null) projet.fin = sprintIndex;
          }
          sprintIndex++;
        }
        
        // Ajout d'une marge de 1 sprint par projet
        for (let projet of projetsRestants) {
          projet.sprints += 1;
          projet.fin = (projet.fin ?? 0) + 1;
        }
        return projetsRestants;
      }

      // Fonction utilitaire pour la date de fin pr√©visionnelle
      function getDateFin(proj) {
        if (!proj.dateDebut) return "-";
        const SPRINT_DAYS = 10;
        const d = new Date(proj.dateDebut);
        const totalDays = proj.sprints * (SPRINT_DAYS + 2);
        d.setDate(d.getDate() + totalDays);
        return d.toLocaleDateString('fr-FR');
      }

      // Helper pour √©tat du projet
      function getEtatProjet(proj) {
        if (proj.fini) return 'livre';
        const dateFinStr = getDateFin(proj);
        if (!dateFinStr || dateFinStr === '-') return 'en_cours';
        const [jour, mois, annee] = dateFinStr.split('/').map(Number);
        const dateFin = new Date(annee, mois - 1, jour);
        const now = new Date();
        dateFin.setHours(0,0,0,0);
        now.setHours(0,0,0,0);
        const diffJours = Math.ceil((dateFin - now) / (1000 * 60 * 60 * 24));
        if (diffJours < 0) return 'retard';
        if (diffJours <= 7) return 'bientot_retard';
        return 'en_cours';
      }

      // Affichage du planning dans le tableau avec filtres
      function renderPlanningTable() {
        const planning = genererPlanning(devs, projects);
        const projectsById = Object.fromEntries(projects.map(p => [p.id, p]));
        
        // Associer l'√©tat 'fini' du projet d'origine
        const planningWithFini = planning.map(p => ({ ...p, fini: projectsById[p.id]?.fini ?? false }));
        
        // Tri par priorit√© puis date de d√©but
        const planningSorted = [...planningWithFini].sort((a, b) => {
          if (a.priorite !== b.priorite) return a.priorite - b.priorite;
          if (!a.dateDebut && b.dateDebut) return 1;
          if (a.dateDebut && !b.dateDebut) return -1;
          if (!a.dateDebut && !b.dateDebut) return 0;
          return new Date(a.dateDebut) - new Date(b.dateDebut);
        });

        // R√©cup√©rer les valeurs des filtres
        const filtrePriorite = document.getElementById('filtrePriorite').value;
        const filtreEtat = document.getElementById('filtreEtat').value;
        const filtreDev = document.getElementById('filtreDev').value;

        // Filtrage
        const planningFiltred = planningSorted.filter(proj => {
          if (filtrePriorite && String(proj.priorite) !== filtrePriorite) return false;
          if (filtreEtat) {
            const etat = getEtatProjet(proj);
            if (filtreEtat === 'en_cours' && etat !== 'en_cours') return false;
            if (filtreEtat === 'livre' && etat !== 'livre') return false;
            if (filtreEtat === 'retard' && etat !== 'retard') return false;
            if (filtreEtat === 'bientot_retard' && etat !== 'bientot_retard') return false;
          }
          if (filtreDev) {
            if (!proj.devsAffectesIds || !proj.devsAffectesIds.includes(Number(filtreDev))) return false;
          }
          return true;
        });

        const tbody = document.getElementById('planningTableBody');
        tbody.innerHTML = '';
        
        planningFiltred.forEach((proj, idx) => {
          const p = projectsById[proj.id] || {};
          let rowClass = "transition hover:bg-accent/10 ";
          
          if (p.fini) {
            rowClass += "bg-green-50 ";
          } else {
            // On parse la date de fin pr√©visionnelle
            const dateFinStr = getDateFin(proj);
            if (dateFinStr && dateFinStr !== '-') {
              const [jour, mois, annee] = dateFinStr.split('/').map(Number);
              const dateFin = new Date(annee, mois - 1, jour);
              const now = new Date();
              dateFin.setHours(0,0,0,0);
              now.setHours(0,0,0,0);
              const diffJours = Math.ceil((dateFin - now) / (1000 * 60 * 60 * 24));
              if (diffJours < 0) rowClass += 'bg-red-50 ';
              else if (diffJours <= 7) rowClass += 'bg-orange-50 ';
              else rowClass += (idx % 2 === 0 ? 'bg-gray-50 ' : 'bg-white ');
            } else {
              rowClass += (idx % 2 === 0 ? 'bg-gray-50 ' : 'bg-white ');
            }
          }
          
          const tr = document.createElement('tr');
          tr.className = rowClass;
          
          // Calculer l'affichage du retard
          let retardHtml = '';
          if (!p.fini) {
            const dateFinStr = getDateFin(proj);
            if (dateFinStr && dateFinStr !== '-') {
              const [jour, mois, annee] = dateFinStr.split('/').map(Number);
              const dateFin = new Date(annee, mois - 1, jour);
              const now = new Date();
              dateFin.setHours(0,0,0,0);
              now.setHours(0,0,0,0);
              const diffJours = Math.ceil((now - dateFin) / (1000 * 60 * 60 * 24));
              if (diffJours > 0) {
                if (diffJours < 30) {
                  retardHtml = `<div class="text-xs text-red-600 font-bold mt-1">${diffJours} jour${diffJours > 1 ? 's' : ''} de retard</div>`;
                } else {
                  const moisRetard = Math.ceil(diffJours / 30);
                  retardHtml = `<div class="text-xs text-red-600 font-bold mt-1">${moisRetard} mois de retard</div>`;
                }
              }
            }
          }
          
          tr.innerHTML = `
            <td class="px-4 py-3 font-semibold text-dark text-base rounded-l-xl border-b border-gray-200">${proj.nom}</td>
            <td class="px-4 py-3 border-b border-gray-200">
              <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-bold border ${STATUTS_PROJET[p.statut || 'conception']?.color || STATUTS_PROJET['conception'].color}">
                ${STATUTS_PROJET[p.statut || 'conception']?.icon || STATUTS_PROJET['conception'].icon} ${STATUTS_PROJET[p.statut || 'conception']?.label || STATUTS_PROJET['conception'].label}
              </span>
            </td>
            <td class="px-4 py-3 border-b border-gray-200">
              <span class="inline-block px-2 py-1 rounded-full text-xs font-bold ${proj.priorite === 1 ? 'bg-primary/90 text-white' : proj.priorite === 2 ? 'bg-accent/90 text-white' : 'bg-gray-200 text-gray-700'}">${proj.priorite}</span>
            </td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700 font-medium">${proj.points}</td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700 font-medium">${proj.sprints}</td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700 whitespace-nowrap">${getDateFin(proj)}${retardHtml}</td>
            <td class="px-4 py-3 border-b border-gray-200 text-gray-700">${(() => {
              // Si le projet a des d√©veloppeurs sp√©cifiquement affect√©s, les afficher
              if (proj.devsAffectesIds && proj.devsAffectesIds.length > 0) {
                return devs
                  .filter(dev => proj.devsAffectesIds.includes(dev.id))
                  .map(dev => dev.prenom + ' ' + dev.nom)
                  .join(', ');
              }
              // Sinon, afficher tous les d√©veloppeurs (comportement par d√©faut)
              return devs.map(dev => dev.prenom + ' ' + dev.nom).join(', ');
            })()}</td>
            <td class="px-4 py-3 border-b border-gray-200 rounded-r-xl">
              ${p.fini ? 
                '<span class="inline-block px-3 py-1 rounded-full bg-green-600/90 text-white text-xs font-bold">Livr√©</span>' : 
                '<span class="inline-block px-3 py-1 rounded-full border-2 border-accent text-accent bg-accent/10 text-xs font-bold">En cours</span>'
              }
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      // Fonction pour initialiser les filtres
      function initFiltres() {
        const planning = genererPlanning(devs, projects);
        const projectsById = Object.fromEntries(projects.map(p => [p.id, p]));
        const planningWithFini = planning.map(p => ({ ...p, fini: projectsById[p.id]?.fini ?? false }));
        
        // Remplir le filtre priorit√©
        const filtrePriorite = document.getElementById('filtrePriorite');
        const priorites = [...new Set(planningWithFini.map(p => p.priorite))].sort((a,b)=>a-b);
        priorites.forEach(prio => {
          const option = document.createElement('option');
          option.value = prio;
          option.textContent = prio;
          filtrePriorite.appendChild(option);
        });

        // Remplir le filtre d√©veloppeur
        const filtreDev = document.getElementById('filtreDev');
        devs.forEach(dev => {
          const option = document.createElement('option');
          option.value = dev.id;
          option.textContent = `${dev.prenom} ${dev.nom}`;
          filtreDev.appendChild(option);
        });

        // Ajouter les event listeners pour les filtres
        document.getElementById('filtrePriorite').addEventListener('change', renderPlanningTable);
        document.getElementById('filtreEtat').addEventListener('change', renderPlanningTable);
        document.getElementById('filtreDev').addEventListener('change', renderPlanningTable);
      }
              document.addEventListener('DOMContentLoaded', function() {
          initFiltres();
          renderPlanningTable();
        });
    </script>
  </body>
</html> 